<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Cloud Foundry Rolling Deployments | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Cloud Foundry Rolling Deployments</h1><p class=blog-page_details>Jun 24, 2020<span>|</span> Andy Paine</p><div class=blog-page_image><img src=/img/blog/v3-deployments/rolling-waves.jpg></div><p><a href=https://www.cloudfoundry.org/blog/cloud-foundry-foundation-announces-availability-of-new-features-to-make-modern-application-development-even-simpler-for-developers/>Version 7 of Cloud Foundry&rsquo;s <code>cf</code> CLI is now generally available</a>. This makes rolling deployments a first-class feature, and adds many more flexible workflows than the original <code>cf push</code> offered. These changes bring the Cloud Foundry user experience more in line with what users have come to expected from Kubernetes&rsquo; Deployments. <strong>Rolling deployments are now available</strong> - so why should you switch?</p><h2 id=a-history-of-cf-push>A History of <code>cf push</code></h2><p>Over the last 18 months, the Cloud Controller (the brains of Cloud Foundry) has been extended to support a new set of APIs - collectively known as V3. Combined with the new V7 of the <code>cf</code> CLI, more of the internals of the app deployment process are (optionally) exposed to users.</p><p>There are now three approaches:</p><ul><li>simple <code>cf push</code></li><li>blue/green deployments</li><li>new rolling deployments</li></ul><h3 id=simple-cf-push>Simple <code>cf push</code></h3><p>Historically, Cloud Foundry&rsquo;s <code>cf push</code> command was intentionally atomic - all instances of an app were taken down, before new ones were added. This was to protect the users of apps whose developers were making breaking changes from inconsistent behaviour.</p><p>In this older model, there is only one logical app in the Cloud Controller database. When the new version of the code starts running, the identifier of the app hasn&rsquo;t changed, so all previous settings are retained.</p><p>A simple <code>cf push</code> is shown at the top of the following graph, with a long period of error responses whilst the app is being replaced:</p><h3 id=bluegreen-deployments>Blue/green deployments</h3><p>Cloud Foundry has always offered the features for a zero-downtime deployment using a variant of the <a href=https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html>blue-green deployment strategy</a>. Blue-green deployments allow for zero downtime by creating an entirely new application for the new code each time (the <code>blue</code> deployment) before switching traffic over from the old application (the <code>green</code> deployment).</p><p>Importantly this required <em>a new app</em> in the database of Cloud Foundry - so a new and unrelated app, with a different ID. Cloud Foundry had no way of knowing that it was a newer version of the same codebase. Events and logs relating to the old version would use the old app ID, and when the old app was deleted (because the new version was live) these data would also be lost.</p><h3 id=rolling-deployments>Rolling deployments</h3><p>Rolling deployments leverage the new V3 <a href=https://v3-apidocs.cloudfoundry.org/index.html#processes><strong>processes</strong></a> to allow an existing app to be updated without downtime. When an app is deployed with <code>cf push --strategy rolling</code>, Cloud Foundry replaces instances of the old process with instances of the new process one-by-one whilst routing traffic to all healthy instances. Not every customisation applied to an application can be specified in the <code>manifest.yml</code>, but by updating an application in-place, all <strong>existing history and configuration is persisted</strong>.</p><h2 id=benefits-of-rolling-deployments>Benefits of Rolling Deployments</h2><h3 id=service-bindings>Service bindings</h3><p>Cloud Foundry service brokers implement the <a href=https://www.openservicebrokerapi.org/>Open Service Broker API</a> which specifies that each service binding should use a unique set of credentials. When deploying with a legacy blue-green strategy, new service bindings and <strong>new credentials are generated every time</strong>. This can make it hard to track which applications are accessing a service and result in permissions errors during releases where new credentials are not authorised correctly. Rolling app deployments solve this by using the <strong>same service binding</strong> every time you deploy.</p><h3 id=network-policies>Network policies</h3><p>Applications utilising <a href=https://docs.cloudfoundry.org/devguide/deploy-apps/routes-domains.html#internal-routes>container-to-container networking</a> require network policies to allow traffic between apps. Network policies are associated with app GUIDs meaning new apps created during a legacy blue-green deployment will not be able to communicate with others. Rolling deployments solve this by updating the application in place, <strong>removing network interruptions during deploys</strong>.</p><h3 id=meaningful-audit-events>Meaningful audit events</h3><p>The <code>cf events</code> command can track changes to an application over time, providing useful insight into what was changed and when. Rolling deployments provide a persistent view of <strong>how an application has changed over time</strong> including deploys, changes and crashes.</p><h3 id=instance-quotas>Instance quotas</h3><p>Cloud Foundry organisations and spaces are subject to <a href=https://v3-apidocs.cloudfoundry.org/index.html#organization-quotas>quotas</a> that limit the amount of computing power users can consume. Blue-green deployments require running <strong>twice as many instances</strong> of an application during deployment. Multiple apps being deployed at the same time can easily tip a user over their allowed quota resulting in failed deployments. Rolling deployments instead only add <strong>one more instance at a time</strong>, providing the same uninterrupted service, without exceeding any quotas.</p><h3 id=droplets-and-revisions>Droplets and revisions</h3><p>When an app is pushed to Cloud Foundry, it is built into an executable package known as a <a href=https://v3-apidocs.cloudfoundry.org/index.html#droplets>droplet</a> during the staging process. V3 also introduces the concept of <a href=https://v3-apidocs.cloudfoundry.org/index.html#revisions>revisions</a> which represent a snapshot of the code and configuration of an application. With rolling deployments, apps have a full history of droplets and revisions, allowing for <strong>fast and safe rollbacks</strong> to previous versions of an app.</p><h3 id=rolling-restarts>Rolling restarts</h3><p>Sometimes an app needs restarting or restaging - to pick up new configuration, fetch an updated service binding or to clear out a cache. Both commands can now be performed without downtime by adding <code>--strategy rolling</code>, following the same one-by-one replacement strategy as deployments.</p><h2 id=using-rolling-deployments>Using Rolling Deployments</h2><p>The good news is that it&rsquo;s as simple as running <code>cf push --strategy rolling</code>, providing that you&rsquo;re using v7 of the <code>cf</code> CLI and are targeting a Cloud Foundry running capi-release v0.168.0 or later.</p><blockquote><h3 id=deejays-notes>Deejay&rsquo;s notes</h3></blockquote><blockquote><p>It&rsquo;s great that this is now a first-class feature in Cloud Foundry. Given that Cloud Foundry prides itself on providing a great developer experience, it&rsquo;s somewhat unfortunate that it&rsquo;s taken months if not years to get here. Kubernetes&rsquo; Deployments have been providing a less-surprising default behaviour for a while now.</p></blockquote><blockquote><p>The Cloud Controller is particularly hard to refactor, and I hope to see its responsibilities diminish as <a href=https://github.com/cloudfoundry/cf-for-k8s><code>cf-for-k8s</code></a> progresses. The default behaviour of <code>cf push</code> and <code>cf restart</code> made sense ten years ago when Cloud Foundry was nascent, and 12 Factor applications were new to world. This is a timely and much-needed improvement if Cloud Foundry is going to uphold the principle of least astonishment.</p></blockquote></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>