<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>OpenJDK 1.8.0_u40 Kerberos MS Auth Bug | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>OpenJDK 1.8.0_u40 Kerberos MS Auth Bug</h1><p class=blog-page_details>May 18, 2015<span>|</span> Daniel Jones</p><div class=blog-page_image><img src=/img/blog/cerberus.jpg></div><p>I discovered an <a href=https://bugs.openjdk.java.net/browse/JDK-8078439>OpenJDK 1.8.0_u40 bug</a> whereby only the first OID in a Kerberos ticket will be considered for supportability; if your server can only authenticate using mechanisms further down the OID list in the ticket then you&rsquo;re bang out of luck.</p><p>I also observed the same bug in the Oracle JRE v8_u45, which shows how much shared code they have in common.</p><p>I discovered the bug on-site with an enterprise client. After updating their customisation of the Cloud Foundry Java buildpack, apps on the PaaS ceased to be able to authenticate via Kerberos. This was originally manifested by a <code>NullPointerException</code> being thrown by Spring Security Kerberos&rsquo; <code>SunJaasKerberosTicketValidator</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>o</span><span class=o>.</span><span class=na>a</span><span class=o>.</span><span class=na>c</span><span class=o>.</span><span class=na>c</span><span class=o>.</span><span class=na>C</span><span class=o>.[.[.[/].[</span><span class=n>dispatcherServlet</span><span class=o>]</span>    <span class=o>:</span> <span class=n>Servlet</span><span class=o>.</span><span class=na>service</span><span class=o>()</span> <span class=k>for</span> <span class=n>servlet</span> <span class=o>[</span><span class=n>dispatcherServlet</span><span class=o>]</span> <span class=n>in</span> <span class=n>context</span> <span class=n>with</span> <span class=n>path</span> <span class=o>[]</span> <span class=n>threw</span> <span class=n>exception</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>NullPointerException</span><span class=o>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>       <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>kerberos</span><span class=o>.</span><span class=na>authentication</span><span class=o>.</span><span class=na>sun</span><span class=o>.</span><span class=na>SunJaasKerberosTicketValidator$KerberosValidateAction</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>SunJaasKerberosTicketValidator</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>162</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>kerberos</span><span class=o>.</span><span class=na>authentication</span><span class=o>.</span><span class=na>sun</span><span class=o>.</span><span class=na>SunJaasKerberosTicketValidator$KerberosValidateAction</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>SunJaasKerberosTicketValidator</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>151</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>AccessController</span><span class=o>.</span><span class=na>doPrivileged</span><span class=o>(</span><span class=n>Native</span> <span class=n>Method</span><span class=o>)</span>
</span></span></code></pre></div><p>Version 1.0.0-RELEASE of the Spring Kerberos library defensively checked against the unpopulated context and <a href=https://github.com/spring-projects/spring-security-kerberos/commit/f046bd7c69d6dad74eb06a7651cd68060b31ff6f>threw a <code>BadCredentials</code> exception</a>, but thankfully now there appears to be <a href=https://github.com/spring-projects/spring-security-kerberos/commit/5e28e87f581629724ff8a0f6d24c3ebc591a00bb>a better workaround</a>.</p><p>For the client this was a bit of a showstopper. Should they:</p><ol><li>Stay on an old version of the OpenJDK JRE, and be prevented from adopting fixes for zero-day vulnerabilities?</li><li>Stop using Kerberos?</li><li>Rewrite and register core Sun security classes?</li><li>Try and change the way the OIDs are ordered when the ticket is generated?</li><li>Manually fiddle with the incoming Kerberos tickets?</li></ol><p>As a financial company with a reputation to protect, options 1 through 3 were not viable. We investigated changing the way tickets are generated, but sadly Kerberos was a black box to the teams that were responsbile for it. That meant the only viable option was <em>filthy</em>.</p><p>I wrote a thoroughly ungodly <code>KerberosTicketValidator</code> implementation that composed a <code>SunJaasKerberosTicketValidator</code> (sadly due the issues of IP ownership I can&rsquo;t share it with you).</p><p>The <a href=http://docs.spring.io/spring-security/site/extensions/krb/docs/1.0.x/apidocs/org/springframework/security/extensions/kerberos/KerberosTicketValidator.html#validateTicket(byte%5B%5D)>argument to the <code>validate</code> method</a> is a <code>byte[]</code>, so no high-level abstractions here. With the help of the fine people on the OpenJDK Security mailing list, I identified the particular parts of the byte array that would need swapping around to reorder the mechanism OIDs.</p><p>Given a thoroughly filthy hack tactical solution, you&rsquo;d expect rigorous testing, right? Sadly, that wasn&rsquo;t to be. There was no straightforward way to generate a ticket in Java exactly as our Microsoft Kerberos servers were doing. The tickets include a signed timestamp to prevent replay attacks, so I couldn&rsquo;t just store a fixture ticket to test with. The CI server was Linux-based, so no kind of shelling out would have helped (we looked at using <code>curl</code> to generate a ticket, but unsurprisingly it didn&rsquo;t use Microsoft OIDS!). In the end a lot of defensive checks had to suffice.</p><p>The code made it into production and works just fine. The OpenJDK people got the issue addressed pretty quickly, so it was a happy ending all around.</p><p>It&rsquo;s not every day one finds a bug in something as ubiquitous as OpenJDK, and thankfully not everyday one finds oneself rummaging through and blindly modifying byte arrays!</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>