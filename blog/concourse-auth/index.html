<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Concourse Teams - Authentication and Automation | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Concourse Teams - Authentication and Automation</h1><p class=blog-page_details>Sep 9, 2020<span>|</span> Colin Simmons</p><div class=blog-page_image><img src=/img/blog/concourse-auth/airport-security.jpg></div><p>Configuring authentication providers in Concourse is often a source of confusion, with gotcha&rsquo;s that make it easy for newcomers to remove their colleagues&rsquo; access. In this post I explain how Concourse auth can be configured, and why I made <a href=https://github.com/EngineerBetter/concourse-mgmt>concourse-mgmt</a> to make the process more reliable.</p><p>Ever since version 2.0 Concourse has supported dividing a single Concourse installation into one or more teams. These teams can be configured so that only certain individuals can access the pipelines within them. As of now there are multiple <a href=https://concourse-ci.org/auth.html>supported auth providers</a> and <a href=https://concourse-ci.org/user-roles.html>a variety of RBAC roles</a> that can be applied.</p><p>I&rsquo;ve helped many companies with Concourse over the past four years. A common point of confusion is around how Concourse authentication is configured and how it relates to teams.</p><p>At a high level, the <strong>configuration of authentication in Concourse is split into two different steps</strong>: deployment and team configuration.</p><p>A rule of thumb is that you tell Concourse <em>how</em> it can authorise users when you deploy Concourse. This is when you configure one or more auth providers. Once an auth provider is configured you can use <code>fly set-team</code> to tell Concourse which users <em>within an auth provider</em> can access a specific team.</p><p>I find the GitHub auth provider is a good example. At deployment you tell Concourse how to talk to GitHub and when you configure a team you tell Concourse which users can interact with that team based on the entities (organisations or teams) they are a part of in GitHub.</p><p>To understand it further, lets walk though the addition of GitHub auth to a Concourse deployment and how to subsequently use it when creating a team.</p><h2 id=configuring-the-provider>Configuring the Provider</h2><p>Before configuring any teams using GitHub auth we need to configure the auth provider on the web instance of our Concourse.</p><p>This involves:</p><ul><li><a href=https://github.com/settings/applications/new>creating a new OAuth application</a></li><li>setting the <code>CONCOURSE_GITHUB_CLIENT_ID</code> and <code>CONCOURSE_GITHUB_CLIENT_SECRET</code> environment variables for the web executable</li><li>redeploying the web instance.</li></ul><p>The specific mechanism for setting these variables depends on how you are deploying your Concourse (i.e. Helm, BOSH, Docker, etc).</p><p>Once the web instance is started with this new configuration you might think that you wouldn&rsquo;t be able to log into anything until a team has been created to use the GitHub auth provider. You would be wrong.</p><p>As you can see I was able to log in, but since I don&rsquo;t have access to any teams the Concourse appears to be empty.</p><p>When you configure an auth provider you are effectively saying that any user within that provider can log into your Concourse and they <em>can</em> be given access to a team.</p><blockquote><p>It&rsquo;s worth noting that <strong>all basic auth user:password pairs need to be defined at deploy time</strong>.</p></blockquote><h2 id=configuring-the-team>Configuring the Team</h2><p>Now that we&rsquo;ve told Concourse how to talk to GitHub we can create a team that utilises it.</p><p>The only way to configure (non-main) teams is through the <code>fly set-team</code> command. The <code>main</code> team is a special case in that it can only be configured when deploying Concourse.</p><p>Thankfully the <code>set-team</code> command can take a YAML config file as an input which lets you keep team auth setup in source control. A good reference for the different keys for each auth type can be found in the <code>team_config_*</code> test fixtures <a href=https://github.com/concourse/concourse/blob/master/fly/integration/fixtures>in the Concourse source code</a>.</p><p>For example this is the GitHub auth example from the test fixtures:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>member</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>github</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>users</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;some-user&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>viewer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>github</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teams</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;some-org:some-team&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>users</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;some-github-user&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>owner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>github</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>orgs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;some-other-org&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><p>When applied with</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>fly set-team <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --team-name<span class=o>=</span>github-team <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --config<span class=o>=</span>team_config_with_github_auth.yml
</span></span></code></pre></div><p>this will create a team called <code>github-team</code> with the following roles:</p><table><thead><tr><th>Role</th><th>GitHub Org</th><th>GitHub Team</th><th>GitHub User</th></tr></thead><tbody><tr><td>Member</td><td>-</td><td>-</td><td>some-user</td></tr><tr><td>Viewer</td><td>some-org</td><td>some-team</td><td>-</td></tr><tr><td>Viewer</td><td>-</td><td>-</td><td>some-github-user</td></tr><tr><td>Owner</td><td>some-other-org</td><td>-</td><td>-</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h3 id=be-careful-with-fly-set-team>Be careful with <code>fly set-team</code></h3><p>It&rsquo;s quite easy to accidentally revoke your own access to a team when trying to give a new user access. I&rsquo;ve seen this a lot and have done it myself a few times. <strong><code>fly set-team</code> is not an additive command</strong>. Suppose you want to add my GitHub user &lsquo;crsimmons&rsquo; as an owner of the <code>github-team</code> team created above.</p><p>If you assume that <code>fly set-team</code> is additive (as I initially did) you would do something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>fly set-team <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --team-name<span class=o>=</span>github-team <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --github-user<span class=o>=</span>crsimmons
</span></span></code></pre></div><p>However the result of this is:</p><table><thead><tr><th>Role</th><th>GitHub Org</th><th>GitHub Team</th><th>GitHub User</th></tr></thead><tbody><tr><td>Owner</td><td>-</td><td>-</td><td>crsimmons</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p>All the other permissions are gone. Oops! Someone who was owner before running this command is not an owner anymore. This means they can&rsquo;t undo their mistake. Double oops!</p><p>Using the config files instead of imperative commands helps avoid this problem a little bit but <code>fly set-team</code>&rsquo;s non-additive nature still often leads to team owners accidentally removing their own access to the team they manage. This is usually recoverable because owners of the <code>main</code> team are effectively owners of every team implicitly. This allows Concourse administrators to restore lost permissions to team owners.</p><p>Once a Concourse grows to have multiple teams with decentralized owners this problem can start to consume a lot of the administrators&rsquo; time. This coupled with the time it takes to configure a new team with <code>fly</code> suggests some kind of automation would be useful for team management.</p><h2 id=automating-teams>Automating Teams</h2><p>From the perspective of automating team configuration it&rsquo;s quite convenient that both team creation and authentication configuration are handled by the same <code>fly</code> command.</p><p>Based on what I&rsquo;ve seen at various companies, the main wants for team automation are:</p><ul><li>having all team configuration stored in source control</li><li>limit the amount of time an errant <code>fly set-team</code> can break access to Concourse</li><li>make addition of new teams as easy as possible</li></ul><p>Automatic removal of old teams is something that I&rsquo;ve proposed but it is usually seen as too dangerous for the first pass by customers.</p><p>With VMWare&rsquo;s excellent <a href=https://github.com/vmwarepivotallabs/cf-mgmt>cf-mgmt</a> tool in mind I created <a href=https://github.com/EngineerBetter/concourse-mgmt>concourse-mgmt</a> as an example pipeline for managing auth. The readme in the repo describes how to use the pipeline so I won&rsquo;t repeat it here. If you find it useful with your Concourse installation we&rsquo;d be interested to hear about it.</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>