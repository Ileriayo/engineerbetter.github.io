<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Increasing Concourse worker container limits | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Increasing Concourse worker container limits</h1><p class=blog-page_details>Aug 21, 2020<span>|</span> Andy Paine</p><div class=blog-page_image><img src=/img/blog/container-limits/container-limits.jpg></div><p>Concourse runs all pipeline processes inside containers providing isolation, security and customisability. By default each Concourse worker allows only 250 containers to run concurrently, leading to the dreaded <strong><code>max containers reached</code></strong> error message. Thankfully this limit can be <strong>increased with two simple flags</strong>. How can you do this, <em>should</em> you do this, and why was the limit 250?</p><h2 id=hitting-the-limit>Hitting the limit</h2><p>Concourse/Garden is quite clear about what is happening when the container limit is reached, turning the job orange (the colour for &ldquo;something within Concourse has failed&rdquo;) and providing the error message <code>max containers reached</code>.</p><p>The worker that attempted to run the job was already busy running other containers. In situations where the container limits are dominated by a fixed number of resource <code>check</code> containers or small <code>job</code>s, this can start to happen frequently, even when <strong>the worker has spare CPU, free memory</strong> etc.</p><p>Concourse supports volumes that are shared between workers. Workers will stream these volumes between themselves when a job that was previously run on one worker has been scheduled onto a different worker. This can lead to additional network traffic and even <a href=https://aws.amazon.com/ec2/pricing/on-demand/#Data_Transfer>additional cost</a>, which can be alleviated by <strong>running fewer, more powerful worker instances</strong>. The more powerful an instance is, the more likely it is to reach the container limit before exhausting all available resources.</p><h2 id=increasing-the-limit>Increasing the limit</h2><p>Concourse exposes a flag or environment variable for configuring the number of max containers (<code>--garden-max-container</code> or <code>CONCOURSE_GARDEN_MAX_CONTAINERS</code>) which defaults to 250 when not explicitly provided. Increasing this number beyond 250 quickly raises another error: <code>insufficient subnets remaining in the pool</code>.</p><p>When creating a container, Garden allocates that container a set of IP addresses. The range these addresses can be selected from is provided by the <code>--garden-network-pool</code> flag or the <code>CONCOURSE_GARDEN_NETWORK_POOL</code> environment variable, and defaults to <code>10.254.0.0/22</code> - a range of 1024 available addresses. As Garden allocates a <code>/30</code> subnet for each container, this range gets exhausted at 256 running containers - barely more than the 250 max-container limit. By <strong>setting the network pool to <code>10.254.0.0/16</code></strong> to allow for 65,536 potential addresses, which corresponds to 16,384 potential containers, the max-container option can be used by itself to cap the number of containers running per-worker.</p><h2 id=how-high>How high?</h2><p>Given the above tweaks - just how many container <em>can</em> a Concourse worker run? We tested a few scenarios using a Concourse deployed by <a href=https://github.com/EngineerBetter/control-tower>Control Tower</a> to see if the <del>sky</del> instance size was the limit or if Concourse would trip up before then. Control Tower uses <a href=https://www.influxdata.com/time-series-platform/telegraf/>Telegraf</a> for sending metrics data for monitoring jobs which we found to struggle under high loads and so was removed for some tests.</p><ul><li>AWS <code>m4.xlarge</code> instance ~720 containers</li><li>AWS <code>m4.4xlarge</code> instance ~1200 containers</li><li>AWS <code>m4.4xlarge</code> instance without <code>telegraf</code> ~2000 containers</li><li>AWS <code>m4.4xlarge</code> instance without <code>telegraf</code> using experimental Concourse <code>containerd</code> backend ~1700 containers</li></ul><p>These tests were all performed using jobs that ran <code>sleep 1200</code> and all tests eventually concluded due to being limited by available CPU. Running so many containers likely meant that eventually the overhead of performing so many process swaps started to dominate the CPU usage. This is obviously not a realistic workload as real Concourse jobs will be significantly more CPU intensive and would hit contention far before this. The experimental <code>containerd</code> backend seems to perform similarly well as the existing Garden integration and the Concourse team plan on <a href=https://github.com/concourse/concourse/issues/5545>comparing the performance of the two</a>.</p><h2 id=why-250-containers>Why 250 containers?</h2><p>Concourse uses the same default provided by the <a href=https://github.com/cloudfoundry/garden-runc-release>garden-runc-release</a> of 250 containers maximum per-worker. Historically, Garden has mainly been used in <a href=https://docs.cloudfoundry.org/concepts/diego/diego-architecture.html>Diego</a> for running user workloads in Cloud Foundry where features such as disk quotas are an important part of the platform. To implement these disk quotas, fixed-size loop devices were used which are limited to 255 by the kernel itself. Things have moved on since then and Garden now uses an overlay + xfs approach to disk quotas, removing the need for the 255 limit. Diego continues to use this old default due to <strong>not needing to increase the limit</strong> and thus <strong>not having tested beyond 250 containers</strong>.</p><h2 id=concourse-vs-diego>Concourse vs. Diego</h2><p>Concourse has a different usage pattern compared to Diego in that Concourse containers are generally short-lived, and when they are running, they&rsquo;re usually doing some work. Diego is used for running customer sites as well as background processing which can spend significant periods idle. However, <strong>Concourse containers often require fewer resources</strong> than their Diego counterparts - as a pipeline grows and the number of resources increases, a significant number of the available containers are dedicated to <strong>running cheap resource <code>check</code>s</strong> rather than expensive <code>job</code>s. This is particularly true when jobs are triggered infrequently but resources continue to be checked at a constant rate.</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>