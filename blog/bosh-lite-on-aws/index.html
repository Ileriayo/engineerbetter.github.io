<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>BOSH-ception: Deploying a BOSH-lite Director on AWS | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>BOSH-ception: Deploying a BOSH-lite Director on AWS</h1><p class=blog-page_details>Jul 13, 2020<span>|</span> Colin Simmons</p><div class=blog-page_image><img src=/img/blog/yaml-fortune.png></div><p>At EngineerBetter two things we love doing are writing tests and pipelining anything that moves. Recently when working with a client we found ourselves working on some custom BOSH releases. Naturally we started by creating a Concourse pipeline to create releases for us. I won&rsquo;t go through the steps of the pipeline here but we have <a href=https://github.com/EngineerBetter/weavescope-boshrelease/blob/master/ci/pipeline.yml>some</a> <a href=https://github.com/EngineerBetter/prometheus-boshrelease/blob/master/ci/pipeline.yml>examples</a> of other release pipelines on GitHub.</p><p>As part of the TDD process we wanted to add some comprehensive system tests to our pipeline to help us resolve some issues that the client had been seeing with the release in the past. Unfortunately this meant we would need to deploy the release candidate of our release as well as some other releases to a real BOSH director every time we ran the test job. We wanted a &lsquo;clean&rsquo; director for each test to reduce flakiness of our tests so this raised an interesting question:</p><h3 id=the-first-attempt>The First Attempt</h3><p>The first thing we tried was running our task in the <a href=https://github.com/chuanran/bosh/tree/master/ci/docker/main-bosh-docker>main-bosh-docker image</a>. This let us run the following command at the start of our system test to start a director:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>. start-bosh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o /usr/local/bosh-deployment/uaa.yml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o /usr/local/bosh-deployment/credhub.yml
</span></span><span class=line><span class=cl><span class=nb>source</span> /tmp/local-bosh/director/env
</span></span></code></pre></div><p>There had to be another way&mldr;</p><h3 id=moving-bosh-back-out-of-the-container>Moving BOSH back out of the container</h3><p>In order to avoid overloading the Concourse workers we will need to deploy the director as a separate VM. We can use <a href=https://bosh.io/docs/bosh-lite/>bosh-lite</a> to create a director which will deploy containers on itself rather than additional VMs. This works by using the <a href=https://github.com/cppforlife/bosh-warden-cpi-release>Warden CPI</a>.</p><p>Most of the time bosh-lite directors are deployed locally onto Virtualbox but it can also be deployed to a different IaaS by swapping out the <code>cpi.yml</code> opsfile from <a href=https://github.com/cloudfoundry/bosh-deployment>bosh-deployment</a> when we deploy. Our client ran most of their development workloads on AWS so we opted for deploying our new director there.</p><p>Something else to note is that there are broadly two ways to deploy things with BOSH: <code>deploy</code> and <code>create-env</code>. The former uses a director to deploy and manage the deployment while the latter creates a standalone deployment that is not managed by a director. BOSH directors are technically bosh deployments themselves but they are almost universally deployed using <code>create-env</code>.</p><p>For our purpose a standalone director VM is unfavourable for two reasons. Firstly it is by definition not supervised by anything and thus won&rsquo;t be resurrected if it breaks. Secondly, <code>deploy</code> is easier to manage from a Concourse pipeline thanks in part to the <a href=https://github.com/cloudfoundry/bosh-deployment-resource>bosh deployment resource</a>.</p><p>While <a href=https://starkandwayne.com/blog/resurrecting-bosh-with-binary-boshes/>it has been done before</a>, deploying a director from another director is not a common occurrence. We couldn&rsquo;t find this process documented anywhere using modern BOSH tooling. We realised that it would be really convenient if we could deploy a bosh-lite director using the same director than deployed the Concourse we were using for testing.</p><h3 id=any-problem-can-be-solved-with-enough-ops-files>Any problem can be solved with enough ops files</h3><p>The difference between the <code>create-env</code> and <code>deploy</code> commands is the schema of the manifests consumed by each of them. When running <code>bosh create-env</code> you must provide a <a href=https://bosh.io/docs/deployment-manifest/>v1 manifest</a> which contains all the networking and CPI information for the deployment. In the transition to <a href=https://bosh.io/docs/manifest-v2/>the v2 manifest</a> the networking/IaaS considerations were split out into the cloud config. <code>bosh deploy</code> requires a v2 manifest. This means our problem is now to convert <a href=https://github.com/cloudfoundry/bosh-deployment/blob/master/bosh.yml><code>bosh.yml</code></a> from v1 to v2.</p><p>Rather than taking the file and modifying it directly, we prefer applying adjustments using <a href=https://bosh.io/docs/cli-ops-files/>ops files</a> so that we can pick up updates to bosh-deployment without facing massive merge conflicts.</p><p>The key changes are:</p><ul><li>allow for a custom deployment name rather than having it hardcoded to <code>bosh</code></li><li>remove the manifest sections that no longer exist in v2</li><li>add stemcell and update blocks to the manifest</li><li>remove the disable-agent job to enable the agent (🤯)</li><li>define vm details and networks that exist in parent director&rsquo;s cloud config</li></ul><p>After defining these changes in ops files it was easy to write a pipeline using the bosh-deployment-resource to deploy our new director for us.</p><p>In our case, we had to make some additional changes because our director wasn&rsquo;t able to generate variables. You can see all our ops files and our deployment pipeline in <a href=https://github.com/EngineerBetter/bosh-lite-on-aws>https://github.com/EngineerBetter/bosh-lite-on-aws</a></p><h3 id=using-the-new-director>Using the new Director</h3><p>Since the bosh-lite director has been deployed by Concourse, it is really easy to target it from a different pipeline on the same Concourse team as CredHub variables will be available.</p><p>In order to communicate with the new director the following environment variables are needed:</p><ul><li><code>BOSH_ENVIRONMENT</code>: provided when deploying director</li><li><code>BOSH_CLIENT</code>: admin</li><li><code>BOSH_CLIENT_SECRET</code>: provided or generated when deploying director (as <code>admin_password</code>)</li><li><code>BOSH_CA_CERT</code>: provided or generated when deploying director</li></ul><p>For <code>bosh ssh</code> to work you will also need the director&rsquo;s SSH key which is provided or generated at deployment time.</p><p>Then set <code>export BOSH_ALL_PROXY=ssh+socks5://jumpbox@${BOSH_ENVIRONMENT}:22?private-key=/path/to/private/key.pem</code></p><p>Note that unless you gave your bosh-lite director an external IP, you will only be able to connect from a VM on the same private network. We considered this to be a nice security side-effect since we only intended to use this director from a Concourse that is managed by the same director.</p><p>Even though we are exporting <code>BOSH_ALL_PROXY</code> to allow <code>bosh ssh</code> to connect to deployments on the bosh-lite director, commands like <code>curl</code> will also need to connect through a proxy. One way to set this up is by starting a background proxy then setting the <code>ALL_PROXY</code> env var.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ssh -fN -D <span class=m>9090</span> -o <span class=s2>&#34;StrictHostKeyChecking=no&#34;</span> jumpbox@<span class=si>${</span><span class=nv>BOSH_ENVIRONMENT</span><span class=si>}</span> -i <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/key.pem
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ALL_PROXY</span><span class=o>=</span>socks5h://localhost:9090
</span></span></code></pre></div><p>The final consideration is that now this director is separate from the Concourse task, it will only be in a clean state at the start of a new task if we run something to clean it up. We opted to add some cleanup trap statements to each of our task scripts. For example:</p><p>As an example you could put the following at the start of a script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=k>function</span> cleanup<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>set</span> +e
</span></span><span class=line><span class=cl>  bosh -d some-test-deployment delete-deployment -n
</span></span><span class=line><span class=cl>  bosh clean-up --all
</span></span><span class=line><span class=cl>  <span class=nb>set</span> -e
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> cleanup_with_exit<span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>rv</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>  cleanup
</span></span><span class=line><span class=cl>  <span class=c1># stop the ALL_PROXY tunnel</span>
</span></span><span class=line><span class=cl>  pkill -f <span class=s1>&#39;ssh.*-f&#39;</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=nv>$rv</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>trap</span> cleanup_with_exit EXIT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cleanup
</span></span></code></pre></div><h3 id=next-steps>Next steps</h3><p>While this setup drastically reduced the build times of our system tests (about an hour saved per build) it still isn&rsquo;t perfect. In particular, relying on tasks to clean themselves up fully is a fragile assumption. It would be nice if the director could be recreated between each build. It would also be useful if this bosh-lite director could be used by multiple different pipelines at the same time.</p><p>Something we&rsquo;ve talked about is having a pool of these bosh-lite directors running on AWS then allowing pipeline jobs to &ldquo;check out&rdquo; a director in order to run a task. Then upon release the director could be recreated before being returned to the pool. If we end up implementing this in the future I&rsquo;ll be sure to write a follow-up blog post.</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>