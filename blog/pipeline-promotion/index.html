<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Properly Promoting Pipelines | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Properly Promoting Pipelines</h1><p class=blog-page_details>Aug 8, 2019<span>|</span> Colin Simmons</p><div class=blog-page_image><img src=/img/blog/promotion/flow.png></div><p>At EngineerBetter we spend a lot of time building Concourse pipelines to deploy complex systems such as Cloud Foundry. Here is an example of one of these pipelines:</p><p>It is simple, easy to understand, and it gets the job done. For most customers, however, the objective is rarely to deploy just one foundation. Usually there is a need for multiple deployments in multiple regions and possibly even on a multitude of IaaSes. Getting updates through this multi-dimensional labyrinth without breaking anything is the real challenge.</p><p>Our recommendation to customers is to always run at least three &ldquo;levels&rdquo; of foundations.</p><ol><li>Sandbox where the platform team can test new releases without worrying about causing downtime.</li><li>Pre-Production where developers can test changes.</li><li>Production where the end users are.</li></ol><p>The general idea is that any change or update to the platform is sequentially made then tested in each level before being promoted to the next.</p><h2 id=problems-with-promotion>Problems with Promotion</h2><p>This strategy is good in theory but once you start planning an implementation a number of questions start to appear.</p><ul><li>How do you figure out what versions of all the resources have passed the pipeline?</li><li>How do we pin versions of any resource type?</li><li>How can all of this happen without manual interaction?</li></ul><p>This topic quickly becomes ðŸ¤¯ once you dive into it so it helps to tackle each question individually.</p><h2 id=what-versions-did-my-pipeline-use>What versions did my pipeline use?</h2><p>The first problem we need to tackle is how to determine the versions of resources that have passed through the pipeline successfully. Logically the best time to determine this is at the end of the pipeline. Therefore our first change is to <a href=https://concourse-ci.org/get-step.html#get-step-passed>pass</a> each resource all the way through the pipeline from wherever it is first used to the end. We&rsquo;ll also add a placeholder job called promote-versions to the end which <code>get</code>s all of these versions.</p><p>Our pipeline now looks like this:</p><p>Next we can flesh out the implementation of this new job. The goal is that we input all the versions and output a file containing their versions.</p><p>Here is a task that does this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pipeline-promotion</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>build-metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>outputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>resource-versions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>CONCOURSE_URL</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>CONCOURSE_USERNAME</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>CONCOURSE_PASSWORD</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>run</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>bash</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;-euc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    fly --target ci \
</span></span></span><span class=line><span class=cl><span class=sd>      login \
</span></span></span><span class=line><span class=cl><span class=sd>      --insecure \
</span></span></span><span class=line><span class=cl><span class=sd>      --concourse-url &#34;$CONCOURSE_URL&#34; \
</span></span></span><span class=line><span class=cl><span class=sd>      --username &#34;$CONCOURSE_USERNAME&#34; \
</span></span></span><span class=line><span class=cl><span class=sd>      --password &#34;$CONCOURSE_PASSWORD&#34;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    fly -t ci sync
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    export ATC_BEARER_TOKEN=$(bosh int --path /targets/ci/token/value ~/.flyrc)
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    PIPELINE_NAME=$(&lt;build-metadata/build-pipeline-name)
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    team=$(cat build-metadata/build-team-name)
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    job=$(cat build-metadata/build-job-name)
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    stopover.v2 \
</span></span></span><span class=line><span class=cl><span class=sd>    ${CONCOURSE_URL} \
</span></span></span><span class=line><span class=cl><span class=sd>    $team \
</span></span></span><span class=line><span class=cl><span class=sd>    ${PIPELINE_NAME} \
</span></span></span><span class=line><span class=cl><span class=sd>    $job \
</span></span></span><span class=line><span class=cl><span class=sd>    $(cat build-metadata/build-name) \
</span></span></span><span class=line><span class=cl><span class=sd>    &gt; resource-versions/versions.yml</span><span class=w>    
</span></span></span></code></pre></div><p>The secret sauce in this task is <a href=https://github.com/EngineerBetter/stopover>stopover</a> which is a Golang CLI we made for this exact purpose. Essentially stopover uses the <a href=https://github.com/mastertinner/build-metadata-resource>metadata resource</a> and the <a href=https://github.com/concourse/concourse/tree/master/go-concourse>Concourse Go client</a> to grab all the resources that were gotten in the job running the task.</p><p>In our case the outputted <code>versions.yml</code> file looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resource_version_bosh-deployment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=l>ef486c57bb2a1139d2caa1c548cb8e952c30aad6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_build-metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>random</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;13192&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_cf-deployment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;17959355&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>v9.3.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timestamp</span><span class=p>:</span><span class=w> </span><span class=ld>2019-06-13T02:50:15Z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_cf-smoke-tests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=l>8f6d750879fecebfc8104a2848ddcfff55526053</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_pcf-ops-image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>digest</span><span class=p>:</span><span class=w> </span><span class=l>sha256:f5f55baeaf22cab8032d553aa4db01c6b77098b73d7fd30203a8a49bc1728ca5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_pipeline-promotion</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=l>d8e32d793d97658a6736ad77f42b2cb94ea65990</span><span class=w>
</span></span></span></code></pre></div><h2 id=using-the-stopover-output-file>Using the stopover output file</h2><p>So now we have a new YAML file. What do we do with it?</p><p>When you set a pipeline you can provide a vars file with <code>--load-vars-from</code>. So we can use our new YAML file to fill in placeholders on every resource pinning them to these specific versions. In order to pin resources of any resource-type (even bosh-deployment) we can use the <a href=https://concourse-ci.org/get-step.html#get-step-version><code>version</code> option on <code>get</code></a>. This lesser known option lets you specify a specific version to <code>get</code> <em>in the format that the resource presents versions to Concourse</em>. Coincidentally this is the format that <code>stopover</code> produces.</p><p>Since this is a feature of Concourse rather than part of a specific resource implementation it will work the same way for any resource type.</p><p>So the first time we get each resource we just need to add a <code>version</code> placeholder. For example, the start of a <code>terraform</code> job would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>terraform</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>plan</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>in_parallel</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>get</span><span class=p>:</span><span class=w> </span><span class=l>pipeline-promotion</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>((resource_version_pipeline-promotion))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>trigger</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>get</span><span class=p>:</span><span class=w> </span><span class=l>pcf-ops-image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>((resource_version_pcf-ops-image))</span><span class=w>
</span></span></span></code></pre></div><h3 id=how-do-we-set-sandbox>How do we set sandbox?</h3><p>You may have noticed that we now need a versions file from <code>stopover</code> to set our pipelines. Sounds great but how do we set the first pipeline in the chain since there is no stopover output to use? Generally the first pipeline in the chain is for deploying the sandbox foundation where we just want to use the latest available version of everything.</p><p>The easiest approach is to create a static versions file for this pipeline with <code>latest</code> as every version. The placeholder version file in our case would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resource_version_bosh-deployment</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_build-metadata</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_cf-deployment</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_cf-smoke-tests</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_pcf-ops-image</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resource_version_pipeline-promotion</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span></code></pre></div><h2 id=tying-it-all-together>Tying it all together</h2><p>Now we&rsquo;ve got a list of all the resource versions that have passed each pipeline and we know how to use this file to pin the resource versions in the next environment(s).</p><p>The next step is to make these links between pipelines happen without manual intervention. The final approach for automating environment promotion varies greatly from customer to customer. For an example of how we helped <a href=https://unit2games.com/>Unit 2 Games</a> do this check out <a href=/blog/continuous-infrastructure-google-cloud>our blog post on Continuous Infrastructure on GCP</a></p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>