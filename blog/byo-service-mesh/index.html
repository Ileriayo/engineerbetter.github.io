<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>BYO Service Mesh to Cloud Foundry | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>BYO Service Mesh to Cloud Foundry</h1><p class=blog-page_details>Aug 7, 2020<span>|</span> Andy Paine</p><div class=blog-page_image><img src=/img/blog/byo-service-mesh/cf-and-consul.svg></div><p>Cloud Foundry has <a href=https://docs.cloudfoundry.org/adminguide/service-mesh.html>toyed around</a> with the idea of providing service mesh capabilities to end users for a while. As CF transitions to a Kubernetes-based runtime, it looks like operators will soon be able to bring the full power of Istio & friends to their developers. But what if <strong>you aren&rsquo;t an operator</strong> and you want all those features <em>today</em>?</p><p>Enter <a href=https://www.consul.io/>Hashicorp Consul</a>. Consul offers service networking features such as health checking and service discovery whilst also bringing all the service mesh goodness of zero-trust networks, weighted traffic routing and circuit breaking. The best thing about it? <strong>You can use these features on (almost) any Cloud Foundry deployment as an end-user</strong>.</p><p>Through some clever usage of <a href=https://docs.cloudfoundry.org/concepts/understand-cf-networking.html>container-to-container networking</a>, <a href=https://docs.cloudfoundry.org/devguide/sidecars.html>sidecars</a> and a little bit of <a href=https://docs.cloudfoundry.org/adminguide/metadata.html>metadata</a> magic, you can deploy Consul and the service mesh sidecars to any application.</p><h2 id=simple-ingress-style-routing>Simple ingress-style routing</h2><p>Normally in Cloud Foundry, applications talk HTTP via the Gorouter which provides all the TLS and layer 7 routing goodness we&rsquo;ve come to know and love.</p><p>For many years Cloud Foundry has also offered direct TCP routing too, so apps can use non-HTTP protocols, or handle their own TLS termination.</p><p>One down side of very early versions of Cloud Foundry was that this approach made it difficult to make apps accessible only within the platform, and to avoid traffic &lsquo;going out and back in&rsquo;.</p><p>Thankfully several years ago container-to-container networking functionality was added to Cloud Foundry so that apps can communicate directly to each other using any protocol required. However, as this method does not include the Gorouter, application developers need to implement their own logging and metrics for these internal requests.</p><h2 id=container-to-container-networking>Container-to-container networking</h2><p>Consul requires a control plane made up of Consul agents running in &ldquo;server&rdquo; mode and, optionally, a UI. The <strong>Consul control plane can be deployed as Cloud Foundry apps</strong>, using the binary buildpack.</p><p>It is recommended that you run a minimum of 3 instances for high availability which then communicate to form quorum and elect a leader. For this consensus algorithm to work, each instance needs to be able to <strong>uniquely address other instances</strong> and be allowed to communicate using <strong>TCP and UDP</strong>.</p><p>We can do this in Cloud Foundry by using <a href=https://docs.cloudfoundry.org/devguide/deploy-apps/routes-domains.html#internal-routes>internal routes</a> as well as <a href=https://docs.cloudfoundry.org/concepts/understand-cf-networking.html>container-to-container networking</a>.</p><h3 id=internal-routes>Internal routes</h3><p>There is a special domain name in Cloud Foundry reserved for applications within the platform: <code>apps.internal</code>.</p><p>Applications can be mapped to a route such as <code>consul-server.apps.internal</code> which all other applications on the platform can use to resolve the IP address of the containers running the <code>consul-server</code> application.</p><p>Individual instances can also be queried by prepending the instance index before the domain, e.g. <code>1.consul-server.apps.internal</code>. This allows applications on the platform to <strong>uniquely address other instances</strong> which ticks our first box.</p><h3 id=network-policies>Network policies</h3><p>Access between applications is denied by default but can be modified by <a href=https://docs.cloudfoundry.org/devguide/deploy-apps/cf-networking.html#create-policies>adding network policies</a> to permit traffic on certain port ranges and protocols. By creating network policies between instances of the <code>consul-server</code> application, we can allow both <strong>TCP and UDP</strong> traffic for the relevant port ranges.</p><h2 id=sidecars>Sidecars</h2><p>Once the Consul control plane is up and running, you need some applications to register into a service mesh. This is done in Consul by running a couple of other processes on the application instance:</p><ul><li>Consul agent - registers with control plane and provides configuration</li><li>Proxy - configured by Consul agent. Controls access, routes traffic and performs mTLS communication with rest of service mesh</li></ul><p>Cloud Foundry has first class support for running these processes: <a href=https://docs.cloudfoundry.org/devguide/sidecars.html>sidecars</a>. These processes are started within the same container as the <code>process_types</code> to which they are bound and are monitored using the <code>process</code> health check type the same way the main application is.</p><blockquote><p>These sidecars could even be seamlessly included via a sidecar-buildpack</p></blockquote><p>By creating Consul services to represent each application, the sidecar proxies can be configured with all dependent services as upstreams. This allows an application to <strong>access other applications as if they were local</strong> with the proxy looking after service discovery as well as connecting to the upstream service over mutual TLS.</p><h2 id=metadata>Metadata</h2><p>Most objects in Cloud Foundry (e.g. apps, spaces, orgs) can have <a href=https://docs.cloudfoundry.org/adminguide/metadata.html>metadata</a> associated with them. This combination of annotations and labels can be used for attaching useful information such as commit hashes or environment.</p><p>By labelling all the applications inside our <a href=https://github.com/EngineerBetter/byo-service-mesh/blob/blog-post/manifest.yml#L25-L27>service mesh</a>, not only can we quickly see and query all applications that belong in the mesh but we can also use that information to ensure that networking is properly configured. <a href=https://github.com/EngineerBetter/byo-service-mesh/blob/blog-post/network-policies.rb>The included script</a> checks that all applications which are labelled this way may communicate freely with each other across ports 8000-9000 and both TCP and UDP.</p><h2 id=putting-it-all-together>Putting it all together</h2><p>To demonstrate all this working together, we can use <a href=https://github.com/jaegertracing/jaeger/tree/master/examples/hotrod>HotROD</a>, a set of example microservices usually used to demonstrate Jaeger&rsquo;s distributed tracing. HotROD is comprised of 4 applications:</p><ul><li>frontend (requires access to customer, driver & route)</li><li>customer</li><li>driver</li><li>route</li></ul><p>Normally these would all be <strong>run on a single host</strong> - as shown by the fact that the address used for the other services is <a href=https://github.com/jaegertracing/jaeger/blob/85d01426d33c77ebb909a5a224c3bdbb89eb94e8/examples/hotrod/cmd/frontend.go#L37-L40>hard coded!</a> However, by deploying each service as a separate Cloud Foundry app integrated into a Consul service mesh, we can work around this.</p><p>The customer, driver and route services can all be registered as <a href=https://github.com/EngineerBetter/byo-service-mesh/blob/b400ab10e8302a4d13666598227ad94485f8eae1/consul.d/hotrod-frontend/service.json#L8-L21>upstreams</a> for the frontend service, making them appear as if they are running on the same host as the frontend. With Consul instead proxying all the requests to the backend services to their respective sidecars over mTLS, the microservices <strong>can continue to communicate, even when deployed on different hosts</strong>.</p><h3 id=benefits>Benefits</h3><p>Whilst this is a pretty neat trick, the real benefits of Consul come now that the applications are embedded into the service mesh. Consul can accept configuration to modify how the service mesh communicates, using the same infrastructure-as-code approach that Hashicorp offers with <a href=https://www.terraform.io/>Terraform</a>. These options include:</p><h3 id=access-control>Access control</h3><p>Consul has a concept called <a href=https://www.consul.io/docs/connect/intentions>intentions</a> that can be used to block access between specific application instances. These can be quickly applied and removed without having to restart applications thanks to the Consul agents constantly checking whether requests are permitted.</p><h3 id=layer-7-traffic-management>Layer 7 traffic management</h3><p>Whether it is canary deployments or A/B testing, being able to fine tune how traffic is routed to applications is a handy tool to have. Consul has a number of layer 7 <a href=https://www.consul.io/docs/connect/l7-traffic-management>traffic management</a> features that make new ways of deploying and running applications possible.</p><h3 id=observability>Observability</h3><p>When using container-to-container networking, requests no longer pass through the Gorouter meaning we lose all metrics derived from Gorouter data. Consul proxies can be centrally configured to emit metrics in a number of different ways providing extremely fine grained data even for application-to-application communication.</p><h2 id=conclusion>Conclusion</h2><p>With Cloud Foundry providing an easy way to run applications with health monitoring, logging and rolling deployments out of the box, even complex deployments are quick to develop. There are still many interesting avenues to explore including security, automating metrics and configurable sidecar buildpacks to leverage other features of Cloud Foundry to make the process easier to set up and manage.</p><p>Together with all the Cloud Foundry features we know and love, these powerful new capabilities demonstrate just how flexible of a platform Cloud Foundry has become. Getting this project running took <strong>less than two days of work</strong> (and was all done on the public, multi-tenant Pivotal Web Services!) - <strong>a testament to how easy deploying to Cloud Foundry can be</strong> without significant platform customisation.</p><blockquote><p>Running a <strong>configurable, zero-trust service mesh on top of Cloud Foundry</strong> without any &ldquo;magic&rdquo; or fuss - who would have thought?</p></blockquote></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>