<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>CI Shootout: Triggering, Inputs, and Outputs | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>CI Shootout: Triggering, Inputs, and Outputs</h1><p class=blog-page_details>Oct 13, 2021<span>|</span> Tom Godkin</p><div class=blog-page_image><img src=/img/blog/gunfight-enchanted-springs.jpg></div><p>In <a href=/blog/ci-shootout-getting-started/>the previous blog</a> we looked at getting started with four self-hosted CI systems: Jenkins, Concourse, Tekton & Argo Workflows. In this post we continue by looking at the next set of use cases:</p><ul><li><a href=/blog/ci-shootout-getting-started><em>First post</em></a> - 1. <strong>Install</strong> and configure the CI system</li><li><a href=/blog/ci-shootout-getting-started><em>First post</em></a> - 2. <strong>Run</strong> a &ldquo;Hello, World&rdquo; task</li><li><em>This post</em> - <a href=#3-trigger-pipeline-runs>3. <strong>Trigger</strong> pipeline runs when external resources (eg Git repos, S3 buckets) change</a></li><li><em>This post</em> - <a href=#4-use-inputs-and-outputs-to-tasks>4. Use <strong>inputs and outputs to tasks</strong></a></li><li><em>This post</em> - <a href=#5-writing-output-to-external-resources>5. Write <strong>outputs externally</strong> (like making a Git commit or pushing a file to S3)</a></li><li><a href=/blog/ci-shootout-reuse><em>Third post</em></a> - 6. <strong>Re-use</strong> pipeline configuration</li><li><a href=/blog/ci-shootout-reuse><em>Third post</em></a> - 7. Use the CI system as a <strong>build monitor</strong></li><li><a href=/blog/ci-shootout-conclusion><em>Final post</em></a> - 8. Conclusion</li></ul><h2 id=3-trigger-pipeline-runs>3. Trigger pipeline runs</h2><p>Running tasks in CI manually is all well and good, but for CI to be useful, it&rsquo;ll need some amount of automation. Here we&rsquo;ll evaluate different mechanisms that can be used for triggering pipelines. In particular we&rsquo;ll look at triggering on:</p><ul><li>new commits to a Git repository</li><li>new files in an S3 bucket</li><li>a timed schedule</li></ul><p>We&rsquo;ll also examine whether each of these systems supports a &lsquo;push&rsquo; (external systems send events to the CI server via <a href=https://en.wikipedia.org/wiki/Webhook>webhooks</a>) or &lsquo;pull&rsquo; (the CI server regularly polls external systems) model when it comes to external triggers.</p><h3 id=jenkins---good>Jenkins - <em>Good</em></h3><p>Jenkins does not model external resources as any kind of first-level concept. It does, to some extent, support two of the use cases we&rsquo;re interested in out of the box.</p><p>Jenkins&rsquo; declarative pipelines can be configured with a cron schedule for triggering. Each pipeline can also be configured with a VCS URL which supports either push-based triggering via webhooks, or pull-based via polling the repository.</p><p>There&rsquo;s a Jenkins plugin that&rsquo;ll let you upload files to S3, but unfortunately that same plugin can&rsquo;t trigger pipelines when the contents of the bucket change.</p><p>Each Jenkins declarative pipeline only supports referencing a single VCS repository, so it isn&rsquo;t possible to trigger on changes to multiple repositories. To work around this you&rsquo;d need to configure webhooks on each repository to trigger the one pipeline.</p><p>Webhooks are a popular way to trigger CI systems in the cloud native world, but that does put those who don&rsquo;t wish to expose their build systems to the outside world in an awkward position. For example, it might be tricky to convince a bank to open their CI system, which deploys to production, to the public internet so that it can receive webhooks.</p><p>In a later blog post we&rsquo;ll encounter frustration with the lack of triggering on S3 (without hooks) when we discuss promotion of change via a bill of materials.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#39;1.1&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;flow-definition</span> <span class=na>plugin=</span><span class=s>&#34;workflow-job@2.40&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;properties&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;triggers&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;hudson.triggers.TimerTrigger&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;spec&gt;</span>@hourly<span class=nt>&lt;/spec&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/hudson.triggers.TimerTrigger&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;hudson.triggers.SCMTrigger&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;spec&gt;</span>H/2 * * * *<span class=nt>&lt;/spec&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;ignorePostCommitHooks&gt;</span>false<span class=nt>&lt;/ignorePostCommitHooks&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/hudson.triggers.SCMTrigger&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/triggers&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/properties&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;definition</span> <span class=na>class=</span><span class=s>&#34;org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition&#34;</span> <span class=na>plugin=</span><span class=s>&#34;workflow-cps@2.90&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scm</span> <span class=na>class=</span><span class=s>&#34;hudson.plugins.git.GitSCM&#34;</span> <span class=na>plugin=</span><span class=s>&#34;git@4.7.1&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;configVersion&gt;</span>2<span class=nt>&lt;/configVersion&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;userRemoteConfigs&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;hudson.plugins.git.UserRemoteConfig&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;url&gt;</span>https://github.com/EngineerBetter/iac-example<span class=nt>&lt;/url&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/hudson.plugins.git.UserRemoteConfig&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/userRemoteConfigs&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;branches&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;hudson.plugins.git.BranchSpec&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;name&gt;</span>main<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/hudson.plugins.git.BranchSpec&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/branches&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/definition&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/flow-definition&gt;</span>
</span></span></code></pre></div><p> </p><h3 id=concourse---great>Concourse - <em>Great</em></h3><p><a href=https://concourse-ci.org/resources.html>Resources</a> in Concourse are implemented based around a strict binary API; each resource can:</p><ul><li><strong>get</strong> a version of that resource type</li><li><strong>put</strong> a new version, or</li><li><strong>check</strong> for new versions.</li></ul><p>By default, Concourse will check for new versions of each resource every two minutes and jobs that use those resources can be configured to trigger when a new version is found.</p><p>For example, suppose your pipeline was processing a CSV file that was to be found in a S3 bucket. By modelling that file as a resource your Concourse will check the bucket every two minutes and will trigger any configured jobs automatically. The amount of configuration required to set this up is trivial.</p><p>Concourse supports a vast array of resource types, with many being provided by Concourse by default. Here are some examples of those that are supported: <a href=https://github.com/concourse/git-resource>Git repositories</a>, <a href=https://github.com/concourse/s3-resource>S3 buckets</a>, <a href=https://github.com/concourse/time-resource>timers</a>, and <a href=https://github.com/concourse/registry-image-resource>registry images</a>. On the rare occasion that the resource type you want to use isn&rsquo;t built in to Concourse, it&rsquo;s probably already been built by the community such as <a href=https://github.com/ljfranklin/terraform-resource>Terraform backends</a> or <a href=https://github.com/concourse/pool-resource>semaphores</a>.</p><p>Since Concourse follows a &lsquo;pull&rsquo; model for resources, it is ideally suited for environments that are not accessible from the public internet.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-concourse</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>source</span><span class=p>:</span><span class=w> </span>{<span class=nt>uri</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://github.com/EngineerBetter/iac-example-concourse&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>plan</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>get</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-concourse</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>trigger</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>task</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image_resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>registry-image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>source</span><span class=p>:</span><span class=w> </span>{<span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>busybox}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>echo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>hello]</span><span class=w>
</span></span></span></code></pre></div><p> </p><h3 id=tekton---poor>Tekton - <em>Poor</em></h3><p>As covered in <a href=/blog/ci-shootout-getting-started>the first post</a>, Tekton may be optionally deployed with a few other components to allow Events to trigger either a TaskRun or a PipelineRun. The sequence of events is:</p><ol><li>A hook configured in VCS hits the URL of a Tekton EventListener</li><li>The EventListener uses a TriggerBinding to create a TaskRun or PipelineRun</li><li>The pipeline is executed</li></ol><p>All of this is exposed to the pipeline author and this is the method used for any programmatic triggering of Tekton pipelines.</p><p>In configuring our Tekton pipeline to trigger hourly, we had to configure three separate Kubernetes resources using about 60 lines of YAML (for reference, configuring an hourly run of Concourse involved deploying nothing and 4 lines of YAML).</p><p>Several things raised our eyebrows whilst configuring triggers for our Tekton pipeline. First, the issue identified with triggering in Jenkins - it only works if the CI server is accessible from the public internet.</p><p>Secondly, the number of moving parts involved to configure something as simple as an hourly run of our pipeline seemed excessively complicated. This is probably due to the fact that Tekton is Kubernetes native and so there&rsquo;s no getting around implementing it this way without introducing layers of abstraction over Tekton.</p><p>It seems as though Tekton is designed with the intention that higher layers of abstraction should be built over the top of it. For example it wouldn&rsquo;t be <em>too</em> difficult to introduce a polling adapter Cron job that interfaces with Concourse&rsquo;s resource binary interface to check for new version of resources.</p><p><em>cron.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*/60 9-16 * * *&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>curlimages/curl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;curl&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-X&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;POST&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--data&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;el-cron-listener.default.svc.cluster.local:8080&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></div><p><em>listener.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>triggers.tekton.dev/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>EventListener</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cron-listener}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>triggers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cron-trig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bindings</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=l>cron-binding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>template</span><span class=p>:</span><span class=w> </span>{<span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-pipeline-template}</span><span class=w>
</span></span></span></code></pre></div><p><em>template.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>triggers.tekton.dev/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>TriggerTemplate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-pipeline-template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcetemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>tekton.dev/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PipelineRun</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>generateName</span><span class=p>:</span><span class=w> </span><span class=l>deploy-pipeline-run-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span>{<span class=nt>iac-example-definition</span><span class=p>:</span><span class=w> </span><span class=l>run}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelineRef</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-deploy}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workspaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secret</span><span class=p>:</span><span class=w> </span>{<span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-tekton-deploy-key}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-source</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeClaimTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ReadWriteOnce]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>requests</span><span class=p>:</span><span class=w> </span>{<span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi}</span><span class=w>
</span></span></span></code></pre></div><p><em>binding.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>triggers.tekton.dev/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>TriggerBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cron-binding</span><span class=w>
</span></span></span></code></pre></div><p> </p><h3 id=argo-workflows---mediocre>Argo Workflows - <em>Mediocre</em></h3><p>Argo Workflows&rsquo; triggering mechanisms are realised by using another tool from the Argo toolkit: <a href=https://argoproj.github.io/argo-events/>Argo Events</a>. Events are installed onto a Kubernetes cluster by applying configuration available via the <a href=https://argoproj.github.io/argo-events/installation/>Argo Events installation docs</a>.</p><p>The architecture of Argo Events contains one or more Event Sources that configure their target resource (such as a GitHub repository or Amazon SNS) to make the Event Source aware of changes in their state (such as a <code>git push</code> or a pull request). The Event Source will then write an Event to the EventBus. Separately, Argo Sensors are configured on the cluster that will respond to particular Events. One such Sensor is able to trigger creation of Argo Workflow resources (such as triggering a Workflow).</p><p>The model is remarkably similar to Tekton and uses a push rather than a pull model. It is slightly easier to configure than Tekton since the Event Source does the work of configuring the external resource on your behalf (such as configuring a GitHub webhook). Again as with Tekton the amount of configuration required to run a Workflow hourly is an order of magnitude more than Concourse requires.</p><p><em>eventsource.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>EventSource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>eventsource-calendar}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>calendar</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>main</span><span class=p>:</span><span class=w> </span>{<span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>1h}</span><span class=w>
</span></span></span></code></pre></div><p><em>sensor.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Sensor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sensor-cron}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w> </span>{<span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>operate-workflow-sa}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dependencies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cron-dep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>eventSourceName</span><span class=p>:</span><span class=w> </span><span class=l>eventsource-calendar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>eventName</span><span class=p>:</span><span class=w> </span><span class=l>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>triggers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>webhook-workflow-trigger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>argoWorkflow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=l>workflows</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operation</span><span class=p>:</span><span class=w> </span><span class=l>submit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Workflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>generateName</span><span class=p>:</span><span class=w> </span><span class=l>hello-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>workflowTemplateRef</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workflow-template-hello}</span><span class=w>
</span></span></span></code></pre></div><p> </p><h3 id=summary>Summary</h3><p>Both Tekton and Argo Workflows require installation of additional components (such as a cron job or a sensor) in order to trigger builds based on external changes such as timers. Approaching these two systems from nothing required an amount of reading and tinkering with YAML that seems to defy the simplicity of &lsquo;run this once an hour&rsquo;.</p><p>Jenkins and Concourse pipelines were trivial to trigger programmatically by comparison, with Jenkins falling shy of a &ldquo;Great&rdquo; rating due to the pipeline being coupled to a single repository.</p><h2 id=4-use-inputs-and-outputs-to-tasks>4. Use <strong>inputs and outputs to tasks</strong></h2><p>Now that pipelines are triggered by external resources, we&rsquo;ll look at how to use those resources in our tasks. Specifically we&rsquo;ll look at using code in a Git repository to run tests, rather than a static &ldquo;Hello World&rdquo; task from the previous post.</p><h3 id=jenkins---good-1>Jenkins - <em>Good</em></h3><p>Since we&rsquo;d already defined a Git repository in the previous section in order to trigger the pipeline, the Git repository was always made available by Jenkins and indeed the current working directory of any pipeline stages we defined was the root directory of the repository. This tight coupling with a VCS served us well for this use case, but we can&rsquo;t help but wonder how much extra effort it would involve to use another repository in addition to one that triggers the pipeline.</p><p>One quirk of Jenkins was that we had to specify that we want the workspace cleaned between runs. It&rsquo;d be easy to forget this and pollute your tests with state from a previous run - having workspaces cleaned up by default seems like the kind of thing you&rsquo;d want (almost) all of the time.</p><p>A small snippet of extra configuration is required to ensure a clean workspace:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>pipeline</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>post</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>always</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cleanWS</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p> </p><h3 id=concourse---great-1>Concourse - <em>Great</em></h3><p>Each Concourse Task begins with its working directory containing subdirectories for each input to that Task. For example, a Git resource &ldquo;foo&rdquo; provided as an input will be present within the Task container as a checked out Git repository at <code>./foo</code>.</p><p>In the previous section we showed how Concourse pipelines may be triggered by changes to Git resources. In fact, no additional configuration is required to demonstrate using the repository in that example - it really was that simple.</p><h3 id=tekton---great>Tekton - <em>Great</em></h3><p>Being Kubernetes native, Tekton has implemented sharing of inputs and outputs between TaskRuns by mounting VolumeClaims into each TaskRun. In order to use a Git repository in Tekton, you&rsquo;d have a Task to clone the Git repository into a directory on the mounted VolumeClaim which Tekton&rsquo;s configuration calls a workspace. That workspace is then defined as an output to the Task cloning the repository and an input to whichever Tasks would like to use the repository.</p><p>Much like in Concourse, workspaces are simply directories available to the TaskRun at run time. The Tekton marketplace makes available a few reusable tasks to perform common actions such as cloning a Git repository, which we&rsquo;ve used in the example below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>tekton.dev/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tkn-clone-demo}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>workspaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-tekton</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-clone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>taskRef</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-clone}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>workspaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workspace</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-tekton</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workspace</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>url</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>git@github.com:EngineerBetter/iac-example-tekton.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>workspaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-tekton</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runAfter</span><span class=p>:</span><span class=w> </span><span class=l>git-clone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>taskRef</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-iac-example-tekton}</span><span class=w>
</span></span></span></code></pre></div><p> </p><h3 id=argo-workflows---good>Argo Workflows - <em>Good</em></h3><p>As with Tekton, Argo Workflows moves state between tasks by mounting VolumeClaims to each container. By declaring an input artifact of type &ldquo;git&rdquo;, a Git repository is cloned into the a directory inside the container.</p><p>Argo Workflows makes a number of different artifact types available, including <a href=https://argoproj.github.io/argo-workflows/fields/#artifact>Git repositories, S3</a> and integration with <a href=https://jfrog.com/artifactory/>Artifactory</a>.</p><p>With artifacts modelled as an input to a particular task, it was a little awkward to use when we changed the order of our templates as we had to move the input definition to an earlier template. It&rsquo;d probably be easier to work with had we defined a &ldquo;no op&rdquo; template with our inputs included as the first template in the DAG.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Workflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>generateName</span><span class=p>:</span><span class=w> </span><span class=l>git-workflow-}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoint</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workdir}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ReadWriteMany]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w> </span>{<span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>200Mi}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>templates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;repo_dir</span><span class=w> </span><span class=l>/workdir/iac-example-argo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>git</span><span class=p>:</span><span class=w> </span>{<span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class=l>https://github.com/EngineerBetter/iac-example-argo}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>make]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>test]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;engineerbetter/iac-example-ci:15-promote&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workingDir</span><span class=p>:</span><span class=w> </span><span class=cp>*repo_dir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workdir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/workdir</span><span class=w>
</span></span></span></code></pre></div><p> </p><h3 id=summary-1>Summary</h3><p>All four CI systems made using a Git repository trivial. Argo Workflows had a quirk in that &ldquo;artifact&rdquo; inputs are attached to a template (task), which means changing the order of tasks added an amount of toil.</p><h2 id=5-writing-output-to-external-resources>5. Writing output to external resources</h2><p>A pipeline is of limited use unless it can change the state of something else in the world. In this section we&rsquo;ll evaluate the difficulty involved in committing to a Git repository.</p><h3 id=jenkins---poor>Jenkins - <em>Poor</em></h3><p>Pushing a change to remote in a Git repository in Jenkins was a <em>journey</em>.</p><p>Jenkins has a plugin that can be installed to provide helpers within your declarative pipeline definition that would have made it trivial to change the configured remote Git server, but there was one catch. Due to a long-standing bug it did not work within declarative pipelines.</p><p>Our other option was to directly invoke the Git CLI within a stage in the pipeline, which also didn&rsquo;t work because of issues with the UID alias within the Jenkins container image. (We did manage to resolve the UID issue by building a container image within Jenkins, but the solution added so much complexity that we abandoned it).</p><p>Eventually we created a <em>separate</em> pipeline using an older syntax that was compatible with the Git plugin, and we had our main pipeline trigger this pipeline when it needed to make a commit. This meant we now had our CI logic split across two pipelines, each configured using a different paradigm.</p><p><em>pipeline.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>pipeline</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>stages</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Promote&#39;</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>steps</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>script</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>GIT_REVISION</span> <span class=o>=</span> <span class=n>sh</span><span class=o>(</span><span class=nl>script:</span> <span class=s1>&#39;git rev-parse HEAD&#39;</span><span class=o>,</span> <span class=nl>returnStdout:</span> <span class=kc>true</span><span class=o>).</span><span class=na>trim</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>build</span><span class=o>(</span>
</span></span><span class=line><span class=cl>          <span class=nl>job:</span> <span class=s1>&#39;Push Git Branch&#39;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=nl>propagate:</span> <span class=kc>false</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=nl>wait:</span> <span class=kc>false</span><span class=o>,</span>
</span></span><span class=line><span class=cl>          <span class=nl>parameters:</span> <span class=o>[</span>
</span></span><span class=line><span class=cl>            <span class=n>string</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;GIT_REVISION&#39;</span><span class=o>,</span> <span class=nl>value:</span> <span class=n>GIT_REVISION</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>string</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;REFERENCE&#39;</span><span class=o>,</span> <span class=nl>value:</span> <span class=n>env</span><span class=o>.</span><span class=na>PROMOTES_TO</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><em>push-to-git.xml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#39;1.1&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;project&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;actions/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;description&gt;&lt;/description&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;keepDependencies&gt;</span>false<span class=nt>&lt;/keepDependencies&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;properties&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;hudson.model.ParametersDefinitionProperty&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;parameterDefinitions&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;hudson.model.StringParameterDefinition&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;name&gt;</span>GIT_REVISION<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;description&gt;&lt;/description&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;defaultValue&gt;&lt;/defaultValue&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;trim&gt;</span>false<span class=nt>&lt;/trim&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/hudson.model.StringParameterDefinition&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;hudson.model.StringParameterDefinition&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;name&gt;</span>REFERENCE<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;description&gt;&lt;/description&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;defaultValue&gt;&lt;/defaultValue&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nt>&lt;trim&gt;</span>false<span class=nt>&lt;/trim&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/hudson.model.StringParameterDefinition&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/parameterDefinitions&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/hudson.model.ParametersDefinitionProperty&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/properties&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;scm</span> <span class=na>class=</span><span class=s>&#34;hudson.plugins.git.GitSCM&#34;</span> <span class=na>plugin=</span><span class=s>&#34;git@4.7.1&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;configVersion&gt;</span>2<span class=nt>&lt;/configVersion&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;userRemoteConfigs&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;hudson.plugins.git.UserRemoteConfig&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;url&gt;</span>REPLACE_ME_REPOSITORY_URL<span class=nt>&lt;/url&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;credentialsId&gt;</span>git<span class=nt>&lt;/credentialsId&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/hudson.plugins.git.UserRemoteConfig&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/userRemoteConfigs&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;branches&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;hudson.plugins.git.BranchSpec&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;name&gt;</span>*/main<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/hudson.plugins.git.BranchSpec&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/branches&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;doGenerateSubmoduleConfigurations&gt;</span>false<span class=nt>&lt;/doGenerateSubmoduleConfigurations&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;submoduleCfg</span> <span class=na>class=</span><span class=s>&#34;empty-list&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;extensions/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/scm&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;canRoam&gt;</span>true<span class=nt>&lt;/canRoam&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;disabled&gt;</span>false<span class=nt>&lt;/disabled&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;blockBuildWhenDownstreamBuilding&gt;</span>false<span class=nt>&lt;/blockBuildWhenDownstreamBuilding&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;blockBuildWhenUpstreamBuilding&gt;</span>false<span class=nt>&lt;/blockBuildWhenUpstreamBuilding&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;triggers/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;concurrentBuild&gt;</span>false<span class=nt>&lt;/concurrentBuild&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;builders&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;hudson.tasks.Shell&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;command&gt;</span>echo <span class=ni>&amp;quot;</span>Revision: $GIT_REVISION<span class=ni>&amp;quot;</span>
</span></span><span class=line><span class=cl>echo <span class=ni>&amp;quot;</span>Branch: $REFERENCE<span class=ni>&amp;quot;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>git push origin <span class=ni>&amp;quot;</span>$( git rev-parse <span class=ni>&amp;quot;</span>$GIT_REVISION<span class=ni>&amp;quot;</span> ):refs/heads/${REFERENCE}<span class=ni>&amp;quot;</span><span class=nt>&lt;/command&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;configuredLocalRules/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/hudson.tasks.Shell&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/builders&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;publishers/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;buildWrappers&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;com.cloudbees.jenkins.plugins.sshagent.SSHAgentBuildWrapper</span> <span class=na>plugin=</span><span class=s>&#34;ssh-agent@1.22&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;credentialIds&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;string&gt;</span>git<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/credentialIds&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;ignoreMissing&gt;</span>false<span class=nt>&lt;/ignoreMissing&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/com.cloudbees.jenkins.plugins.sshagent.SSHAgentBuildWrapper&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/buildWrappers&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/project&gt;</span>
</span></span></code></pre></div><p> </p><h3 id=concourse---great-2>Concourse - <em>Great</em></h3><p>The previously visited Concourse resources each define a &lsquo;get&rsquo; and a &lsquo;put&rsquo; step. This means that we can use the <a href=https://github.com/concourse/git-resource>Git resource</a> that was already defined in order to push a commit, branch or tag to that repository. This was ridiculously trivial.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>promote</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>plan</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>put</span><span class=p>:</span><span class=w> </span><span class=l>iac-example-concourse</span><span class=w>
</span></span></span></code></pre></div><p> </p><h3 id=tekton---mediocre>Tekton - <em>Mediocre</em></h3><p>Pushing to a Git repository using Tekton involved invoking the Git CLI in a shell script. Browsing Tekton Hub, we found that the published Git tasks were very operation specific - such as a task for performing a <code>git clone</code>.</p><p>Using a Kubernetes secret which contained the deploy key for our repository, we mounted the deploy key within our Task, at runtime added it to the keychain, and <code>git push</code>ed. Tekton and its ecosystem did not provide tooling to make this any easier.</p><p>There&rsquo;s probably some value in publishing a <code>git push</code> task to Tekton Hub, so that other people could use it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tkn hub install git-clone
</span></span><span class=line><span class=cl>kubectl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace tekton-pipelines <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  apply <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --filename task.yaml
</span></span><span class=line><span class=cl>kubectl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace tekton-pipelines <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  apply <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --filename pipeline.yaml
</span></span></code></pre></div><p><em>pipeline.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>tekton.dev/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tkn-push-demo}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-email</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>workspaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tkn-push-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-clone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>taskRef</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-clone}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>workspaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workspace</span><span class=p>:</span><span class=w> </span><span class=l>tkn-push-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workspace</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>url</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;git@github.com:EngineerBetter/tkn-push-demo.git&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>increment-number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>$(params.git-name)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-email</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>$(params.git-email)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>workspaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tkn-push-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workspace</span><span class=p>:</span><span class=w> </span><span class=l>tkn-push-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workspace</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>taskRef</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-push}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runAfter</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>increment-number]</span><span class=w>
</span></span></span></code></pre></div><p><em>task.yaml</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>tekton.dev/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Task</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-push}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-email</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>workspaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tkn-push-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>increment-number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>alpine/git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>workingDir</span><span class=p>:</span><span class=w> </span><span class=l>$(workspaces.tkn-push-demo.path)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      #!/usr/bin/env sh
</span></span></span><span class=line><span class=cl><span class=sd>      set -euo pipefail
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      eval &#34;$( ssh-agent -s )&#34;
</span></span></span><span class=line><span class=cl><span class=sd>      ssh-add $(workspaces.ssh-directory.path)/id_rsa
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      git config --global user.email &#39;$(params.git-email)&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      git config --global user.name &#39;$(params.git-name)&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      git add ./number
</span></span></span><span class=line><span class=cl><span class=sd>      git commit --message &#39;Increment number&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      git push origin HEAD:main</span><span class=w>      
</span></span></span></code></pre></div><p> </p><h3 id=argo-workflows---mediocre-1>Argo Workflows - <em>Mediocre</em></h3><p>Just as with Tekton, pushing to a Git repository in Argo Workflows involved using the Git CLI directly in a script. In the case of Argo Workflows we had to disable StrictHostKeyChecking explicitly via an environment variable.</p><p>Once again the deploy key we needed was applied as a Kubernetes secret.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>argo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace argo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  submit scratch/manifests/workflow.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --wait <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --parameter <span class=s2>&#34;git-name=</span><span class=nv>$PARAM_GIT_NAME</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --parameter <span class=s2>&#34;git-email=</span><span class=nv>$PARAM_GIT_EMAIL</span><span class=s2>&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Workflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>generateName</span><span class=p>:</span><span class=w> </span><span class=l>git-push-workflow-}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoint</span><span class=p>:</span><span class=w> </span><span class=l>workflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>metadata</span><span class=p>:</span><span class=w> </span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workdir}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ReadWriteMany]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{<span class=nt>requests</span><span class=p>:</span><span class=w> </span>{<span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>200Mi}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ssh-creds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>ssh-directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>0400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>arguments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>parameters</span><span class=p>:</span><span class=w> </span><span class=p>[</span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-name}, {name: git-email}]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>templates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dag</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>increment-number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=l>increment-number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=l>git-push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dependencies</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>increment-number]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>arguments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{workflow.parameters.git-name}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-email</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{workflow.parameters.git-email}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>increment-number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>parameters</span><span class=p>:</span><span class=w> </span><span class=p>[</span>{<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-name}, {name: git-email}]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>alpine/git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>workingDir</span><span class=p>:</span><span class=w> </span><span class=cp>*workdir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w> </span><span class=cp>*volume_mounts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>sh]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        set -euo pipefail
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        eval &#34;$( ssh-agent -s )&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        ssh-add /ssh-creds/id_rsa
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        git config --global user.email &#39;{{workflow.parameters.git-email}}&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        git config --global user.name &#39;{{workflow.parameters.git-name}}&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        git add ./number
</span></span></span><span class=line><span class=cl><span class=sd>        git commit --message &#39;Increment number&#39;
</span></span></span><span class=line><span class=cl><span class=sd>        git push origin HEAD:main</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GIT_SSH_COMMAND</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no</span><span class=w>
</span></span></span></code></pre></div><p> </p><h3 id=summary-2>Summary</h3><p>Both Tekton and Argo Workflows offered no abstractions over performing a Git push.</p><p>Due to an issue in Jenkins that prevented the Git plugin working with Declarative Pipelines, we had to actively fight Jenkins and perform a workaround to achieve a Git push.</p><p>Concourse&rsquo;s resource abstraction meant Git push was 2 lines of YAML.</p><p>It&rsquo;s interesting to compare the amount of time it took us to produce the above Git Push examples (starting from not knowing anything about each system):</p><ul><li>Jenkins took about 4 hours since we had to wade through bug reports and broken example code</li><li>Argo Workflows and Tekton both took about 2 hours to read through docs related to inputs/outputs and produce a working snippet</li><li>Producing the Concourse snippet and seeing it work took about 10 minutes</li></ul><h2 id=scorecard>Scorecard</h2><p> </p><h2 id=next-time>Next time</h2><p>In <a href=/blog/ci-shootout-reuse>the third post</a> in this series we will see how good the systems are for the remaining use cases:</p><ul><li><em><strong>Re-use</strong> pipeline configuration for promotion</em></li><li><em>Use the CI system as a <strong>build monitor</strong></em></li></ul></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>