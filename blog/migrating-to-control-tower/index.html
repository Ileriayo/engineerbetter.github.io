<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Migrating from Concourse-up to Control Tower | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Migrating from Concourse-up to Control Tower</h1><p class=blog-page_details>Mar 26, 2019<span>|</span> Colin Simmons</p><div class=blog-page_image><img src=/img/blog/migrating.jpeg></div><h3 id=catch-your-connecting-flight>Catch your connecting flight</h3><p>We recently announced that we are replacing Concourse-Up with <a href=/blog/concourse-up-renamed-to-control-tower>Control Tower</a>.</p><p>If you are currently running a Concourse using Concourse-up you might be wondering how to migrate over to Control Tower.</p><p>Under the hood Control Tower is Concourse-up with the name word-replaced and a handful of bugfixes/updates. Unfortunately due to some changes such as bucket name changes, deploying with Control Tower over top of Concourse-up will not work.</p><p>We are looking at an automated self-update process to migrate users to Control Tower, but since this is non-trivial and we&rsquo;re keen to hear feedback from users on how valuable this would be, before we spend a lot of engineering effort on this.</p><p>I recently transitioned our own Concourse over at <a href=https://ci.engineerbetter.com>https://ci.engineerbetter.com</a> from Concourse-up to Control Tower using some backup tooling that we wrote. These are the steps I followed.</p><h3 id=step-1---know-your-concourse>Step 1 - Know your Concourse</h3><p>If you don&rsquo;t have it written down, figure out all the deployment flags you used with Concourse-Up. You&rsquo;ll want these to create your Control Tower deployment.</p><h3 id=step-2---deploy-with-control-tower-on-a-different-domain>Step 2 - Deploy with Control Tower on a different domain</h3><p>Deploy a new Concourse using Control Tower using the deployment flags used in your Concourse-up deployment <em><strong>with a different domain</strong></em>. For example, for our deployment I ran:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>control-tower deploy ebci --region eu-west-2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--web-size large <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--domain ci2.engineerbetter.com <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--worker-size 2xlarge
</span></span></code></pre></div><h3 id=step-3---backup-your-data-from-your-concourse-up-deployment>Step 3 - Backup your data from your Concourse-Up deployment</h3><p>Clone down our backup tooling from <a href=https://github.com/EngineerBetter/ct-backup>https://github.com/EngineerBetter/ct-backup</a>.</p><p>From <code>ct-backup</code> run the following to extract all the pipelines, teams, and credhub secrets from your Concourse. Take note of the encryption key in the output as this will be needed to decrypt your Credhub secrets when you import them into Control Tower.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>concourse-up info --iaas &lt;your-iaas&gt; --env &lt;your-deployment&gt;<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ADMIN_PASSWORD</span><span class=o>=</span>&lt;your-concourse-up-admin-password&gt;
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CONCOURSE_URL</span><span class=o>=</span>&lt;your-concourse-up-domain&gt; <span class=c1># i.e. https://ci.engineerbetter.com</span>
</span></span><span class=line><span class=cl>fly -t &lt;target&gt; execute -c examples/backup.yml -o <span class=nv>out</span><span class=o>=</span>./out
</span></span></code></pre></div><h3 id=step-4---import-your-data-to-your-control-tower-deployment>Step 4 - Import your data to your Control Tower deployment</h3><p>Open a new terminal window (to get a fresh environment) and run the following from <code>ct-backup</code> to import all the pipelines, teams, and credhub secrets to your new Control Tower Concourse.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>control-tower info --iaas &lt;your-iaas&gt; --env &lt;your-deployment&gt;<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ADMIN_PASSWORD</span><span class=o>=</span>&lt;your-control-tower-admin-password&gt;
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CONCOURSE_URL</span><span class=o>=</span>&lt;your-control-tower-domain&gt; <span class=c1># i.e. https://ci2.engineerbetter.com</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ENCRYPTION_KEY</span><span class=o>=</span>&lt;encryption-key-from-previous-step&gt;
</span></span><span class=line><span class=cl>fly -t &lt;target&gt; execute -c examples/restore.yml -i <span class=nv>backup_source</span><span class=o>=</span>out --include-ignored
</span></span></code></pre></div><p><strong>Warning: From this point there will be disruption to anyone using your old Concourse</strong></p><h3 id=step-5---record-existing-pipeline-status-and-pause-them>Step 5 - Record existing pipeline status and pause them</h3><p>Make a note of the pipelines that are unpaused/exposed in each team</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># From ct-backup directory</span>
</span></span><span class=line><span class=cl><span class=c1># Log in to each team and run</span>
</span></span><span class=line><span class=cl>fly -t &lt;target&gt; pipelines --json &gt; pipelines-&lt;team&gt;.json
</span></span></code></pre></div><p>Pause all pipelines in each team on old Concourse</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Log in to each team and run</span>
</span></span><span class=line><span class=cl>fly -t &lt;target&gt; pipelines --json <span class=p>|</span> jq -r <span class=s1>&#39;.[].name&#39;</span> <span class=p>|</span> xargs -I <span class=o>{}</span> fly -t &lt;target&gt; pp -p <span class=o>{}</span>
</span></span></code></pre></div><h3 id=step-6---liberate-your-domain-from-concourse-up>Step 6 - Liberate your domain from Concourse-Up</h3><p>Deploy the old Concourse with a third domain. For example, I ran</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>concourse-up deploy --iaas aws --region eu-west-2 --domain<span class=o>=</span>https://ci3.engineerbetter.com ebci
</span></span></code></pre></div><p>This domain swapping is needed because terraform deletes the A record on change even if the record is pointing to a different IP that terraform originally set it to. So if you were to deploy with Control Tower to the same domain as your Concourse-up deployment, it would intially swap the A record over to your new Concourse but then as soon as you delete the Concourse-up deployment it would delete the record for your new Concourse.</p><h3 id=step-7---move-your-control-tower-deployment-to-the-correct-domain>Step 7 - Move your Control Tower deployment to the correct domain</h3><p>Deploy the new Concourse with the original domain. For example, I ran</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>control-tower deploy --iaas aws --region eu-west-2 --domain<span class=o>=</span>https://ci.engineerbetter.com ebci
</span></span></code></pre></div><h3 id=step-8---unpause-and-expose-the-correct-pipelines>Step 8 - Unpause and expose the correct pipelines</h3><p>From <code>ct-backup</code> run the following to unpause + expose pipelines on the new Concourse to match what the old Concourse was set as</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># For each team</span>
</span></span><span class=line><span class=cl>fly -t target login
</span></span><span class=line><span class=cl>examples/unpause_expose.rb target pipelines.json
</span></span></code></pre></div><p>At this point your original domain is pointing to the new Concourse and all the teams, pipelines, and Credhub secrets have been moved across. Pipelines have been unpaused and exposed according to what was configured on your old Concourse. All pipelines on your old Concourse have been paused. The ATC password will have changed but password rotation is a good thing right?</p><h3 id=step-9---clean-up>Step 9 - Clean up</h3><p>If you are happy with your new Control Tower deployment, you can use <code>concourse-up</code> one final time to destroy your old Concourse.</p><p>To chat with our team and other users about Control Tower, please join our community on Slack <a href=https://join.slack.com/t/concourse-up/shared_invite/enQtNDMzNjY1MjczNDU3LTA1NzIxYTZkYjFkMjA2ODBmY2E2OTM3OGE3YTc2OGViNTMxYTY4MjYwNGNjOTAxNDNiOGE5NzhmMTQ2NWVhNzQ>Concourse-Up User Slack</a> and share your thoughts!</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>