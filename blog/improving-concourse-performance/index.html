<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Improving Concourse Performance | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Improving Concourse Performance</h1><p class=blog-page_details>Jul 27, 2018<span>|</span> Paddy Steed & Colin Simmons</p><div class=blog-page_image><img src=/img/blog/profiling/before_keepalive.svg></div><p>Since introducing CredHub into the <a href=https://github.com/EngineerBetter/concourse-up>concourse-up</a> distribution, we became aware of some performance issues with it. We noticed if you had lots of resouces, the load on the ATC would be very high, and the system would feel very sluggish.</p><p>In concourse-up we colocate the Concourse ATC, CredHub, UAA, and some other components on the web VM. We tried scaling this VM to be a larger instance type but saw little to no improvement. We also tried scaling the RDS instance where CredHub stores its credentials to no avail. Even though vertical scaling didn&rsquo;t offer large speed improvement, our Concourse installation was still usable so we didn&rsquo;t worry about it too much.</p><h2 id=performance-regression>Performance Regression</h2><p>This changed when Concourse v3.14.0 was released. This version contained a new feature which allowed Concourse to start even if CredHub was down. After upgrading we noticed that our Concourse was slower than ever and that both concourse-up and the upstream Concourse repo got bug reports about the slowness.</p><p>Concourse&rsquo;s usage of CredHub allows for credentials to be stored in either a team level or a pipeline level path with the latter taking precedence over the former. We knew that this implementation results in a surprising number of requests off of a small number of resources as Concourse will check both path possibilities for each secret.</p><p>For example, suppose you have a Concourse pipeline with the following resource:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>concourse-up</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uri</span><span class=p>:</span><span class=w> </span><span class=l>git@github.com:EngineerBetter/concourse-up.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branch</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>private_key</span><span class=p>:</span><span class=w> </span><span class=l>((github_private_key))</span><span class=w>
</span></span></span></code></pre></div><p>Every time Concourse checks for a new version of this resource (once per minute by default) it will query CredHub for secrets on:</p><ul><li><code>/concourse/TEAM/PIPELINE/github_private_key</code> <em>and</em> on</li><li><code>/concourse/TEAM/github_private_key</code></li></ul><h2 id=investigation-profiling>Investigation, Profiling</h2><p>When we first set out trying to fix this problem in concourse-up we thought we would have to implement a cache for credential lookups. The hope was that this would help to relieve the pressure on CredHub as had been done for Vault. However, we know that because of <a href=https://en.wikipedia.org/wiki/Amdahl%27s_law>Amdahl&rsquo;s law</a>, if we don&rsquo;t understand the problem before we start trying to solve it, we likely won&rsquo;t achieve the best improvements.</p><p>To start our investigation, we used concourse-up to deploy a fresh Concourse. We then wrote <a href=https://gist.github.com/takeyourhatoff/3c8a83a0eab0b3630658531793a926eb>a script</a> that would add a many secrets to CredHub, and then set several pipelines on Concourse that referenced those secrets. All of these pipelines were set to check for new versions of the resources every 10 seconds. Effectively the result was an instantly crawling Concourse. We ran <code>htop</code> on the Concourse&rsquo;s web VM and observed that CPU usage was 100% across both cores, and fairly even between ATC and CredHub.</p><p>We decided we needed to collect CPU profiles to figure out what was going on. Go has excellent tooling for profiling, and the ATC component takes advantage of it. There are two flags which can be used to expose an HTTP endpoint from which the go tool can obtain CPU samples. These endpoints are <code>--debug-bind-ip</code> and <code>--debug-bind-port</code>. By default the latter is set to <code>127.0.0.1</code> which means it cannot recieve traffic from outside the server. We set this flag to <code>0.0.0.0</code> and modified the security group for the ATC on AWS to allow our machine to access that endpoint. We were then able to use the <a href=https://blog.golang.org/profiling-go-programs><code>go tool pprof</code></a> command to collect CPU samples from the running ATC.</p><p>The results were very clear. <em>Most of the CPU time was spent parsing system CA cerficates</em>.</p><p>To better visualise and understand the sample data, we used a fantastic tool created by Uber called <a href=https://github.com/uber/go-torch>go-torch</a>. Using Docker we generated an SVG flame graph of the ATC profile:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>docker run uber/go-torch -u http://<span class=nv>$ATC_EIP</span>:8079 -p &gt; flame.svg
</span></span></code></pre></div><p>The resulting graph was:</p><p>If you haven&rsquo;t encountered flame graphs before, Brendan Gregg wrote a <a href=http://www.brendangregg.com/flamegraphs.html>good primer to them</a>.</p><h2 id=a-subtle-bug>A Subtle Bug</h2><p>This graph indicated that new CredHub clients were being constructed very frequently, and during the constructon of this client, a lot of work was done. The ATC only really needs to construct this client once, then it can reuse the client every time it needs to fetch credentials.</p><p>We noticed that the high CPU usage issue was <a href=https://github.com/concourse/concourse/issues/2300>already being tracked</a> by the Concourse team, which had been introduced in an attempt to fix a <a href=https://github.com/concourse/concourse/issues/2154>previous bug</a>. It also introduced another, more subtle bug.</p><p>Given that <code>lazyCredhub</code> is a struct, can you spot the bug in this method that will cause <code>lc.credhub</code> to <em>always</em> be nil?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>lc</span> <span class=nx>lazyCredhub</span><span class=p>)</span> <span class=nf>CredHub</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>credhub</span><span class=p>.</span><span class=nx>CredHub</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>lc</span><span class=p>.</span><span class=nx>credhub</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>lc</span><span class=p>.</span><span class=nx>credhub</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nx>credhubOnce</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>credhubInstance</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>credhub</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>lc</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=nx>lc</span><span class=p>.</span><span class=nx>options</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>lc</span><span class=p>.</span><span class=nx>credhub</span> <span class=p>=</span> <span class=nx>credhubInstance</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>lc</span><span class=p>.</span><span class=nx>credhub</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The method has a <em>value</em> receiver, and not a <em>pointer</em> receiver. Thus, on each method invocation a new copy of the struct was being created, and the method executed against that. When the method returns, our new instance pops off the stack and the <code>lazyCredhub</code> instance in the calling scope remains completely unchanged.</p><p>We submitted <a href=https://github.com/concourse/atc/pull/291>a fix for this</a> on the ATC component. Then we patched our test Concourse environment and collected a new profile. This generated the following flame graph:</p><p>As you can see this fix eliminated the parsing activities but a large proportion of time is being spent on TLS handshakes.</p><h2 id=a-subtle-performance-gotcha>A Subtle Performance Gotcha</h2><p>Both Concourse and the CredHub CLI are written in Go where TLS operations are handled by <code>net/http</code>. This package uses a goroutine to perform TLS handshakes so we couldn&rsquo;t tell from the profiling data which functions were initiating them. However, since we only saw this behaviour when CredHub was used, we suspected that it was calls to obtain credentials which were initiating these handshakes.</p><p>HTTP 1.1 defaults to using persistent connections. This means that ATC should only be doing a TLS handshake once, then reusing the established session for many subsequent requests. This did not appear to be happening.</p><p>The following is a very common pattern for making HTTP requests in Go:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>myURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>x</span> <span class=nx>X</span>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The problem with this is that the <code>Decode(r)</code> method reads from <code>r</code> until the end of the first json value. <strong>The <code>net/http</code> package will only reuse a HTTP connection if the response body has been read to completion</strong>. In practice, that means you have to read from the body until you receive <code>io.EOF</code> from the read method. Even if you have read all the bytes on the wire, the <code>net/http</code> package doesn&rsquo;t know that and won&rsquo;t return the connection to the idle pool.</p><p>The following code solves this problem by draining the connection before closing it, allowing the connection to be reused.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>myURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>ioutil</span><span class=p>.</span><span class=nx>Discard</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>x</span> <span class=nx>X</span>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>With this in mind we took a look at the credhub-cli and found that it was falling into this trap. We <a href=https://github.com/cloudfoundry-incubator/credhub-cli/pull/45>raised a PR</a> to fix it.</p><h2 id=a-dramatic-improvement>A Dramatic Improvement</h2><p>Once our fix was merged we patched our test Concourse again, collected a new profile, and generated the following flame graph:</p><p>Now the ATC is free to spend all its processing power on ATC-related activities. It no longer has to contend with TLS handshakes and CredHub client creation.</p><p>As a real-world example we built a version of ATC containing all these fixes and patched the EngineerBetter Concourse installation with it. We saw an immediate drop in CPU utilisation on the web VM.</p><p>The cloudwatch graph for this change is below.</p><h2 id=all-fixed>All Fixed!</h2><p>Our fix got merged courtesy of the fine folks on the Concourse team, and now [Concourse v4.0.0][14] should be <em>significantly</em> faster when using CredHub.</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>