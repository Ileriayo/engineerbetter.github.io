<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Overflowing buildpack_cache | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Overflowing buildpack_cache</h1><p class=blog-page_details>Aug 19, 2015<span>|</span> Daniel Jones</p><div class=blog-page_image><img src=/img/blog/overflowing-rubbish.jpg></div><p>Between versions 206 and 211 of Cloud Foundry a bug causes <code>buildpack_cache</code> files to be orphaned, increasing persistent disk usage unless manual remedial action is taken.</p><p>Users will get the error message <code>Staging error: cannot get instances since staging failed</code> when trying to push or restage apps. Depending on your setup you could get higher AWS S3 bills, or you may run out of persistent disk on your Cloud Controller or NFS Server VMs.</p><p>Are you sitting comfortably? Then I&rsquo;ll begin.</p><p>Monday morning on-site at a client, I came in to find that continuous acceptance tests for the &lsquo;app push&rsquo; workflow were failing. They weren&rsquo;t just failing on one Cloud Foundry; they were failing on three quarters of all environments being tested.</p><p>Here&rsquo;s an example of what happened on push:</p><pre tabindex=0><code class=language-shell_session data-lang=shell_session>Using manifest file manifest.yml
OK

Updating app push-test in org -snip!- / space -snip!- as -snip!-...
OK

Uploading push-test...
Uploading app files from: target/connectivity-tester-app-0.0.1-SNAPSHOT.war
Uploading 356.8K, 33 files

Done uploading
OK

Stopping app push-test in org -snip!- / space -snip!- as -snip!-...
OK

Starting app push-test in org -snip!- / space -snip!- as -snip!-...
-----&gt; Downloaded app package (11M)
       -----&gt; Java Buildpack Version: -snip!- | -snip!-
-----&gt; Downloading Open Jdk JRE 1.8.0_51 from -snip!- (0.9s)
       Expanding Open Jdk JRE to .java-buildpack/open_jdk_jre (0.9s)
-----&gt; Downloading Open JDK Like Memory Calculator 1.1.1_RELEASE from -snip!- (0.0s)
       Memory Settings: -Xmx269854K -Xms269854K -XX:MaxMetaspaceSize=64M -XX:MetaspaceSize=64M -Xss1003K
-----&gt; Downloading Spring Auto Reconfiguration 1.7.0_RELEASE from -snip!- (0.0s)
-----&gt; Downloading Tomcat Instance 8.0.18 from -snip!- (0.2s)
       Expanding Tomcat to .java-buildpack/tomcat (0.3s)
-----&gt; Downloading Tomcat Lifecycle Support 2.4.0_RELEASE from -snip!- (0.0s)
-----&gt; Downloading Tomcat Logging Support 2.4.0_RELEASE from -snip!- (0.0s)
-----&gt; Downloading Tomcat Access Logging Support 2.4.0_RELEASE from -snip!- (0.0s)


FAILED
Server error, status code: 400, error code: 170001, message: Staging error: cannot get instances since staging failed
</code></pre><p>A quick poke around the state of VMs in the deployment showed that the NFS Server had maxed out its persistent disk usage. The NFS Server&rsquo;s sole responsibility is to host some persistent storage that the Cloud Controller can then map onto. In other deployments this storage area may be on the Cloud Controller itself or an S3-compatible blobstore.</p><p>The PaaS Ops team had increased the size of the NFS Server&rsquo;s persistent disk only last week, bumping it by another 50%. That it ran out so quickly was rather surprising.</p><p>Initially I&rsquo;d jumped to the conclusion that maybe droplets were getting orphaned. Droplet deletions are delayed jobs that are placed in a queue in the Cloud Controller DB (CCDB).</p><p>I couldn&rsquo;t see any logs suggesting that these jobs were being picked up and executed by the Cloud Controller, but in this case that work was being done by a Cloud Controller Worker job (so <em>that&rsquo;s</em> what a Cloud Controller Worker does!). A quick poke around the CCDB&rsquo;s <code>delayed_jobs</code> table showed no immediately curious patterns.</p><p>Back on the NFS Server VM I had a poke around <code>/var/vcap/store/shared/cc-droplets/</code>. I used <code>du --max-depth=1</code> to try and find which droplets were taking up the most space. Instead I discovered that the <code>buildpack_cache</code> directory was using up way more than all the droplets combined.</p><p>Some GitHub sleuthing led me to discover that whilst making <a href=https://github.com/cloudfoundry/cloud_controller_ng/commit/60021a2146f742892015eab19b9565cd540a2666>a change to the naming strategy for <code>buildpack_cache</code> files</a>, a bug was introduced in <code>cf-release</code> 206 that meant that these files were no longer deleted along with the app they belonged to.</p><p>The <code>buildpack_cache</code> files used to be stored in subdirectories matching their app GUID. This was changed to be subdirectories based on the stack, with app GUID as a suffix. On the Cloud Foundry instances I was looking at the <code>cflinuxfs2</code> stack was in use, meaning all the offending files were in <code>buildpack_cache/cf/li/*</code>.</p><p>The bug was <a href=https://www.pivotaltracker.com/n/projects/966314/stories/95474242>fixed in 211</a> and an <a href=http://apidocs.cloudfoundry.org/211/blobstores/delete_all_blobs_in_the_buildpack_cache_blobstore.html>endpoint added to the CF API</a> to give you a way to purge these through the front door. The Cloud Foundry instances I was dealing with did not have that fix.</p><p>Knowing that later versions of the API would allow you to purge the cache implied that it was read-through, and that bad things would <em>not</em> follow if I cleared it.</p><p>Just to be sure I did some tests on a BOSH Lite Cloud Foundry, and observed the files getting recreated if an app was restaged or re-pushed. Hurrah!</p><p>A quick&mldr;</p><pre tabindex=0><code class=language-shell_session data-lang=shell_session>rm -rf /var/vcap/store/shared/cc-droplets/buildpack_cache/cf/li/*
</code></pre><p>&mldr;on each NFS Server and all was well with the world again.</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>