<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Continuous Infrastructure on Google Cloud | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Continuous Infrastructure on Google Cloud</h1><p class=blog-page_details>Aug 7, 2019<span>|</span> Daniel Jones</p><div class=blog-page_image><img src=/img/blog/crayta.png></div><p>Recently we helped the folks at <a href=https://unit2games.com/>Unit 2 Games</a> <strong>automate the creation</strong> of their <strong>Google Cloud</strong> and <strong>Kubernetes</strong> infrastructure by using <a href=https://concourse-ci.org/>Concourse</a> and EngineerBetter&rsquo;s own best-practice approach to reliably deploying platforms.</p><p>&ldquo;We&rsquo;ve managed to take a huge step forward in our infrastructure automation with the help of EngineerBetter. Where our environments were once hand-crafted and fragile, they are now reliable, easy and flexible, and we&rsquo;re getting really confident with the tooling they recommended.&rdquo;</p><p><em>Tom Gummery - Senior Software Engineer, Unit 2 Games</em></p><p>Before going into <a href=#how-we-worked>how we worked</a> and <a href=#the-implementation>how we achieved this</a>, here&rsquo;s a summary of how Unit 2&rsquo;s pipelines now work:</p><ul><li><strong>All infrastructure is defined in code</strong>, and deployed automatically for <strong>complete auditability and reproducibility</strong>.</li><li>The <strong>many production environments are defined as YAML</strong>, and adding a new environment is as simple as making a Git commit.</li><li>Production environments can <strong><em>only</em> accept changes tested and proven</strong> in multiple prior pipelines.</li><li><strong>Production</strong> is changed via a <strong>canary deployment</strong>, followed by a <strong>rolling update</strong>.</li></ul><h2 id=how-we-worked>How We Worked</h2><p>Unit 2 Games are in the midst of making <a href=https://crayta.com/>Crayta</a>, and awesomely-powerful collaborative gameplay creation tool. Using the Unreal engine, Crayta offers collaborative game creation for all - think a much more advanced and aesthetically-pleasing Roblox.</p><p>The folks at Unit 2 need to be able to deploy rock-solid Kubernetes-based platforms for large numbers of users. As a Game-as-a-Service, these platforms need to be updated continuously whilst live game sessions are going on.</p><p>A global online game doesn&rsquo;t need just one monolithic platform - instead, multiple production environments are required in a number of geographies in order to provide low-latency to users around the world. Not only that, but due to the viral nature of such a social experience, the folks at Unit 2 need to be able to deploy new environments in new territories at a moment&rsquo;s notice.</p><p>&ldquo;Undertaking this work was initially a daunting prospect, but with EngineerBetter&rsquo;s help we broke the work down and delivered great value back to the business. We greatly reduced our fear of change, and so now reap many benefits such as being able to rapidly provision environments, audit infrastructure changes, and tighten system access control.&rdquo;</p><p><em>Steve McDowell - Web Systems Director, Unit 2 Games</em></p><p>EngineerBetter always work collaboratively, so we used <strong>remote mob-programming</strong> to team up with Unit 2. We simultaneously helped build their infrastructure automation solution whilst sharing our experiences and educating their Kubernetes-savvy engineers in the ways of Concourse.</p><p>Unit 2 engineers booked out a meeting room, EngineerBetter dialled in via Zoom, and then we proceeded with usual mobbing rules - 10-minute turns on the keyboard, and you can only type something if someone else has told you.</p><p>Engineering days were not contiguous, and we&rsquo;d spend maybe a few days a week collaborating in this way. This allowed the Unit 2 engineers to attend to other matters, and prevented us from getting remote-work fatigue. It also allowed ideas to percolate, meaning we got &lsquo;creative tunnel vision&rsquo; less often.</p><p>&ldquo;Mobbing over a remote video link turned out to be a effective way of skills transfer and education, whilst also building towards a real deliverable. It has been particularly easy to schedule these sessions in around other work, allowing us to maintain normal service while we develop improvements.&rdquo;</p><p><em>Tom Gummery - Senior Software Engineer, Unit 2 Games</em></p><h2 id=the-implementation>The Implementation</h2><p>In this post we&rsquo;ll refer to stages of QA as <em>tiers</em> - so think things like &lsquo;dev&rsquo;, &lsquo;staging&rsquo; and &lsquo;production&rsquo;. We&rsquo;ll call each freestanding and isolated instance of Unit 2 stack an <em>environment</em>.</p><p>The environments themselves consist of a few different elements:</p><ul><li>A containing GCP project for isolation</li><li>GCS buckets for storing pipeline state</li><li>Load Balancers, DNS and all the usual network gubbins</li><li>A Kubernetes cluster</li><li>GCP and Kubernetes service accounts</li><li>Various Helm charts for things like Ingress</li></ul><h3 id=infrastructure-as-code>Infrastructure as Code</h3><p>As is always the case when we&rsquo;re pipelining platforms, everything that makes up an environment is made concrete in a Git repository.</p><p>A lot of this is Terraform, along with Kubernetes YAML, and the odd bit of custom scripting to glue things together. For example, we want our pipelines to be able to create the buckets they use to hold their state in which creates a bit of a chicken-and-egg problem, so we created <a href=https://github.com/EngineerBetter/concourse-gcp-tf-bootstrap>a reusable Concourse task</a> to do this.</p><h4 id=why-not-just-terraform>Why Not Just Terraform?</h4><p>If we&rsquo;re using Terraform inside our pipelines, why not <em>just</em> use Terraform? Why bother with Concourse at all?</p><p>Applying Terraform is a one-off process. We want our environments to adopt the latest patches, updates and security fixes. Concourse is the driver for that - as a &lsquo;continuous thing-doer&rsquo;, it&rsquo;s watching for upstream releases and then feeding those into Terraform and other tools.</p><h3 id=the-same-code-for-all-environments>The Same Code for All Environments</h3><p>The biggest mistake we see experienced platform teams make when using Concourse is to have different pipeline definitions for production versus other environments.</p><p>If your production Infrastructure-as-Code is different to the tiers you tested in, then <strong>your tests are not valid</strong>. You are quite literally using untested code in production.</p><p>In order to have a cast-iron guarantee that production will work you need to be using the same assets all the way through, giving parity between tiers.</p><p>In practice, this means some sophisticated tricks with Concourse, such as either pipelines that set themselves, or pipelines that set other pipelines. This is explained later.</p><h3 id=promoting-versions-with-stopover>Promoting Versions with Stopover</h3><p>Versions of components in an environment should <strong>only be promoted if they are known to work together</strong>. We need to integration test everything that goes into that environment, and then promote that <em>set</em> of versions to the next tier.</p><p>The simple view of this is that the version of every resource (Git repo, Helm chart, BOSH release) that we&rsquo;re interested in is written to a YAML file upon completion of integration tests. We&rsquo;ve written a <a href=https://github.com/EngineerBetter/stopover>tool to do this called Stopover</a>, which we&rsquo;ll be writing about in more detail some time soon.</p><p>This file is then uploaded to S3, or committed to Git. This act of creating a new version of the file triggers the <em>next</em> pipeline in the chain: so perhaps the <code>dev</code> pipeline writes a file that triggers the <code>staging</code> pipeline. <em>Only</em> this set of versions is used in the subsequent pipeline.</p><h3 id=canaries-and-rolling-upgrades>Canaries and Rolling Upgrades</h3><p>One production environment is the designated &lsquo;canary&rsquo; environment. This is live, has real users, and is also the first of the production environments to deploy a new set of components. Only once this canary environment has been successfully updated do we consider upgrading the others.</p><p>The other production pipelines are configured to be triggered by updates to the versions file that has been &lsquo;promoted&rsquo; by the canary pipeline. I use inverted commas as at this point we&rsquo;re already making live production changes.</p><p>In order to facilitate a rolling upgrade of remaining production deployments, we use the <a href=https://github.com/concourse/pool-resource>Concourse Pool Resource</a>. Each pipeline needs to acquire a lock on a member of the &lsquo;in flight&rsquo; pool for its tier. If there are 10 production environments, then we have 2 members in this pool, meaning there&rsquo;s a 20% max-in-flight. Other pipelines will block waiting for a lock to become available.</p><h3 id=consistency>Consistency</h3><p>Each pipeline is locked to only accept versions of resources that have passed previous pipelines. This means that there is every expectation that they should work, and if they don&rsquo;t, we&rsquo;re discovering something new about environmental differences.</p><p>There are additional consistency safeguards too.</p><p>Our pipelines set themselves. Every time the automation runs, it ensures that it is running with the latest <em>tested</em> version of the automation itself, as well as the latest tested versions of all the other things that make up the platform. Novice Concourse usage involves developers setting pipelines &lsquo;by hand&rsquo;, which is error-prone and oft-forgotten.</p><p>Our pipelines are also atomic. We make further use of the Concourse Pool Resource to ensure that pipeline config can&rsquo;t be reconfigured halfway through a run. Without this, a pipeline could be 75% complete, a new run could be triggered, which would then update the runtime configuration of the pipeline whilst the prior run was still executing!</p><p>Addressing this consistency issue is of such importance that <a href=https://blog.concourse-ci.org/core-roadmap-towards-v10/#rfc-31-set_pipeline-step>setting pipelines is on the roadmap to become a first-class construct in Concourse</a>.</p><h3 id=on-demand-production-environments>On-Demand Production Environments</h3><p>Environments in any tier are defined via YAML. In fact, what makes each environment unique is a set of parameters to the pipeline itself - so things like name, region, cluster size, and so on.</p><p>Adding a new environment is as simple as adding a new YAML file. How so? We have a &lsquo;meta-pipeline&rsquo; that watches this Git repository for changes, and when it detects a new file, sets a new Concourse pipeline using the parameters in that file! Once the pipeline is set, it will automatically keep itself up-to-date via self-setting.</p><p>Of course, the meta-pipeline also sets itself in order to ensure consistency with the latest pipeline definition in Git.</p><h2 id=bringing-it-together>Bringing it Together</h2><p><a href=/img/blog/unit2-pipemania.jpg>You can expand the image for a full view</a> of this rough design diagram.</p><p>Unit 2 Games already had a capable infrastructure automation team, and EngineerBetter were able to accelerate their progress towards having fully-automated GitOps-style infrastructure-as-code on Google Cloud.</p><p>The patterns that we use have been tried and tested in banking, fintech, security, publishing and now gaming. Our technical approach transcends IAASes, and once again mob-programming has proven a flexible method to both upskill and deliver.</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>