<!doctype html><html lang=pl><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Continuously Deploying Pivotal Cloud Foundry | EngineerBetter | More than Cloud Platform specialists</title><link rel=stylesheet href="/css/main.css?v=4"><link rel=stylesheet href=/css/syntax.css><link rel=icon type=image/png href=/img/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-74442484-1","auto"),ga("send","pageview")</script><script src=//load.sumome.com/ data-sumo-site-id=7c63408cd1c29faa63d20123ff629d524df6674695e4305a0e602f2bbf431038 async></script>
<script type=text/javascript>var _iub=_iub||[];_iub.csConfiguration={banner:{textColor:"#dadada",backgroundColor:"#5A5A5A"},lang:"en",siteId:939573,cookiePolicyId:8251825}</script><script type=text/javascript src=//cdn.iubenda.com/cookie_solution/safemode/iubenda_cs.js async></script></head><body><section id=menu-nav-top class="menu fixed-menu clearfix"><div class=menu_contact><p class=menu_contact-number>+44 (0) 20 7846 0140</p><a href=mailto:contact@engineerbetter.com class=menu_contact-us>Contact us</a></div><div class="menu_header clearfix"><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button>
<a href=/ class=menu_header-logo><img class=logo-header-img alt=Brand src=/img/engineer-better-logo.svg></a></div></section><div class=menu_list><button class=menu_list-close><p>&#x2716;</p></button><div class=menu_list-inner-wrap><p class=menu_list-phone>+44 (0) 20 7846 0140</p><a class=menu_list-contact-btn href=mailto:contact@engineerbetter.com>Contact us&nbsp;<span>&#xe900;</span></a><ul class=menu_list-links><li><a href=/how-we-work/>How we work</a></li><li><a href=/our-services/>Our services</a></li><li><a href=/success-stories/>Success stories</a></li><li><a href=/why-cloud-native/>why cloud-native?</a></li><li><a href=/about-us/>About us</a></li><li><a href=/blog/>Blog</a></li></ul><div class=menu_list-icons><a href=https://twitter.com/EngineerBetter><img src=/img/twitter.svg alt="Twitter profile"></a>
<a href=https://github.com/EngineerBetter><img src=/img/github.svg alt="Github profile"></a></div><div class=menu_list-bot-menu><a href=/blog/>Blog</a><span>|</span><a href=/join-our-team/>Careers</a><span>|</span><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy">Privacy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></div></div></div><section class="menu-banner-top_wrap parallax is-page"><div class=menu-banner-top><div class=menu-banner-top_contact><a class=menu-banner-top_number href="tel:+44 (0) 20 7846 0140">+44 (0) 20 7846 0140</a>
<a class=menu-banner-top_contact-us href=mailto:contact@engineerbetter.com>Contact us</a></div><div class=menu-banner-top_btn-wrap><button class=menu_header-button>
<span class="icon-bar top-bar"></span>
<span class="icon-bar middle-bar"></span>
<span class="icon-bar bottom-bar"></span></button></div><div class="menu-banner-top_logo clearfix"><a href=/ class=home-banner_logo-img><img class=logo-img alt=Brand src=/img/engineer-better-logo.svg></a></div></div><div class=home-banner><div class="home-banner_list clearfix"><div class=home-banner_list-category><ul><li><a href=ileri.com/how-we-work/>How we work</a></li><li><a href=ileri.com/our-services/>Our services</a></li><li><a href=ileri.com/success-stories/>Success Stories</a></li><li><a href=ileri.com/why-cloud-native/>Why Cloud-Native?</a></li><li><a href=ileri.com/about-us/>About us</a></li><li><a href=ileri.com/blog/>Blog</a></li></ul></div><div class=home-banner_textarea><h1 class=home-banner_textarea-header>Our <strong>blog&nbsp;<span>&#xe900;</span></strong></h1><div class=home-banner_textarea-wrap><p class=home-banner_textarea-description>Get the very latest updates about recent projects, team updates, thoughts and industry news from our team of EngineerBetter experts.</p></div></div></div></div></section><section class=blog-page><div class=blog-page_container><h1>Continuously Deploying Pivotal Cloud Foundry</h1><p class=blog-page_details>Dec 14, 2016<span>|</span> Peter Ellis Jones</p><div class=blog-page_image><img src=/img/blog/continuous-delivery-ice-cream-factory.jpg></div><p>EngineerBetter recently helped a large financial organisation <strong>fully automate</strong> their Pivotal Cloud Foundry deployments, taking a manual process that took a whole team more than a week, and replacing it with an <strong>hands-off</strong> continuous depoyment pipeline that <strong>took mere hours</strong>, often <strong>overnight whilst the team slept</strong>. We didn&rsquo;t just automate the deployment of their PCF: we <strong>automated</strong> the creation of their <strong>cloud infrastructure</strong>; deployment of <strong>upgrades</strong>; installation of <strong>security updates</strong>; and all with <strong>full testing</strong>.</p><p>Cloud Foundry enables continuous delivery for developers. <strong>EngineerBetter bring continuous delivery to platform operators</strong> and traditional IT teams. Here&rsquo;s how.</p><h2 id=traditional-ops>Traditional Ops</h2><p>The customer has a lot of experience with Cloud Foundry and some very large deployments. However they were using a traditional, release-oriented approach when it came to deploying and maintaining Cloud Foundry. When a new PCF release came out the team would deploy it to a staging environment, test it, and &ldquo;release&rdquo; it to separate ops teams managing prod environments around the world. The upgrade would take around a week, and tied up nearly all of the team&rsquo;s time while it was being done.</p><p>PCF gets updated often. From mid-October to mid-November there averaged an <strong>update every 4 days</strong>. This caused a lot of headaches for the team as updates would get backed-up — <strong>new versions were coming out faster than the team could deploy, test, and release them</strong> leaving prod environments exposed to CVEs for weeks (when this should be measured in hours); a lot of the same manual work was repeated for every upgrade; And they were left with no time to test and deploy new features that development teams were asking them for.</p><p>Cloud Foundry allows app developers to deploy and scale apps seamlessly, so what if we could deploy Cloud Foundry just as easily? What if we could destroy and recreate any number of identically-configured Cloud Foundries at will? What if we had a pipeline that automatically upgraded and tested new versions? Thanks to Pivotal and some forward-thinking supporters within the financial organisation, we got the opportunity to do just that.</p><h2 id=continuously-deploying-cloud-foundry>Continuously Deploying Cloud Foundry</h2><p>If you&rsquo;re deploying Pivotal Cloud Foundry from scratch you&rsquo;ll need to do the following six steps:</p><ul><li>Download the latest version of PCF - you&rsquo;ll need <a href=https://network.pivotal.io/products/elastic-runtime/>Pivotal Elastic Runtime (ERT)</a> and <a href=https://network.pivotal.io/products/ops-manager>Ops Manager</a></li><li><a href=https://docs.pivotal.io/pivotalcf/1-8/installing/>Set up your IaaS</a> (VPCs, S3 buckets etc if you&rsquo;re on AWS; clusters, resource pools, and datastores on vSphere) and <a href=https://docs.pivotal.io/pivotalcf/1-8/customizing/cloudform-om-deploy.html>Deploy an Ops Manager VM</a></li><li><a href=https://docs.pivotal.io/pivotalcf/1-8/customizing/cloudform-om-config.html#access-om>Configure the Ops Manager credentials</a></li><li><a href=https://docs.pivotal.io/pivotalcf/1-8/customizing/cloudform-om-config.html#access-om>Configure and deploy a BOSH Director using Ops Manager</a></li><li><a href=https://docs.pivotal.io/pivotalcf/1-8/customizing/add-delete.html>Upload ERT to the Ops Manager</a></li><li><a href=https://docs.pivotal.io/pivotalcf/1-8/customizing/cloudform-er-config.html>Configure and deploy ERT via the Ops Manager</a></li></ul><p>If you make no mistakes, this takes a couple of hours to half a day to complete. Once it&rsquo;s all done, you&rsquo;ll at least want to run the Cloud Foundry <a href=https://github.com/cloudfoundry/cf-smoke-tests>smoke tests</a>, and possibly more intensive testing depending on your use-case.</p><p>Fortunately all these steps can be automated. Unfortunately, some are easier than others. To help with the automation we chose <a href=https://concourse.ci>Concourse</a> as our CI server. Concourse has three features that make it a great CI server:</p><ul><li><strong>Pipeline-first</strong>. In Concourse you create pipelines composed of multiple jobs composed of multiple tasks. First-class support for pipelines means it&rsquo;s easy to model complex dependencies between jobs. Deploying Cloud Foundry is definitely a pipeline, not a job.</li><li><strong>Isolated builds</strong>. All tasks run on <a href=https://www.opencontainers.org/>OCI images</a> (read: Docker images) using the Garden container manager. Parameters are passed in as environment variables. This ensures builds don&rsquo;t accidentally leave state around that can disrupt other builds (I&rsquo;m looking at you, Jenkins)</li><li><strong>Declarative configuration</strong>. Pipeline configuration is done via YAML files which can be checked into source control, and easily re-applied. This avoids <a href=http://martinfowler.com/bliki/SnowflakeServer.html>snowflake</a> build servers that are expensive or impossible to re-build (still looking at you, Jenkins)</li></ul><p>Using Concourse we set about creating our six-step pipeline:</p><h3 id=1-getting-new-versions-of-pcf>1) Getting new versions of PCF</h3><p>Concourse has a simple extension system that let&rsquo;s anyone define new &ldquo;resources&rdquo;. A resource can be anything that has new versions, like a git repo or a build artifact. One open-source resource is the <a href="https://ci.concourse.ci/teams/main/pipelines/main?groups=develop">pivnet-resource</a>. This downloads new versions of PCF components from network.pivotal.io, and lets you trigger new builds.</p><h3 id=2-preparing-the-iaas-and-deploying-an-ops-manager-vm>2) Preparing the IaaS and Deploying an Ops Manager VM</h3><p>The IaaSs we used all had pretty good APIs and tooling. If you&rsquo;re on AWS, this part will be creating VPCs and networking infrastructure via CloudFormation. On vSphere this is setting up clusters and resource pools. In a continuous delivery pipeline, it&rsquo;s important that every step is <a href=https://en.wikipedia.org/wiki/Idempotence#Examples>idempotent</a> — ie, the job must result in the same state being applied to the system independent of whether it&rsquo;s the first run or the hundredth. CloudFormation does a good job of converging state when a script gets updated but there are some gotchas — for example it&rsquo;s hard to get the current status of a CloudFormation stack. The CloudFormation stack &ldquo;Stack Status&rdquo; property actually tells you the status of <em>the previous operation on the stack</em> rather than the stack itself (eg &lsquo;CREATE_COMPLETE&rsquo; rather than &lsquo;ACTIVE&rsquo;). Thankfully with some a few lines of Bash we were able to ensure this step was idempotent.</p><h3 id=3-configure-the-ops-manager-credentials>3) Configure the Ops Manager credentials</h3><p>Ops Manager is a GUI-based application with a limited API (we deployed version 1.7 — later versions have a better API). We used <a href=https://rubygems.org/gems/opsmgr>opsmgr gem</a> to automate it — this gem is a command line tool uses the API where possible, and Capybara (browser automation) otherwise. Getting Capybara to run in Docker can be tricky, but the short of it is you need <a href=https://en.wikipedia.org/wiki/Xvfb>XFVB</a> for a virtual display server, and run all your scripts within <em>xvfb-run</em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>xfvb-run bundle <span class=nb>exec</span> rake opsmgr...
</span></span></code></pre></div><h3 id=4-configure-and-deploy-a-bosh-director-using-ops-manager>4) Configure and deploy a BOSH Director using Ops Manager</h3><p>The <em>opsmgr</em> gem lets you configure the Ops Manager BOSH Director with a YAML file. Since all configuration is passed from Concourse to the build via environment variables, one pattern we ended up using a lot is templating YAML files from environment variables. Since we had ruby as a dependency anyway, we leveraged <a href=http://www.stuartellis.name/articles/erb/>ERB</a> templates for this, and ended up with a lot of files like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>ops_manager</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>&lt;%= ENV.fetch(&#39;OPSMAN_URL&#39;) %&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>&lt;%= ENV.fetch(&#39;OPSMAN_USERNAME&#39;) %&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>&lt;%= ENV.fetch(&#39;OPSMAN_PASSWORD&#39;) %&gt;</span><span class=w>
</span></span></span></code></pre></div><p>ERB is part of the ruby standard library and has it&rsquo;s own CLI command so writing a template such as the one above is as simple as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>erb template.yml.erb &gt; output.yml
</span></span></code></pre></div><h3 id=5-upload-ert-to-the-ops-manager>5) Upload ERT to the Ops Manager</h3><p>The <em>opsmgr</em> handles this for us nicely, but we added some Bash wrangling to avoid re-uploading tiles if a version was already uploaded. One problem we continually faced was long feedback cycles so we optimised where possible to reduce build times.</p><h3 id=6-configure-and-deploy-ert-via-the-ops-manager>6) Configure and deploy ERT via the Ops Manager</h3><p>The <em>opsmgr</em> gem exposed commands to get and update an <em>installation_settings</em> YAML file. This is a huge YAML that contains all the configuration of all the tiles that will be deployed. If you&rsquo;re familiar with <a href=https://bosh.io/docs/deployment-manifest.html>Bosh manifests</a> the <em>installation_settings</em> file is a like a prototype bosh manifest for all products to be deployed. Although 1.8 exposes better methods for configuring products, unfortunately with Ops Manager 1.7 we had to use the following method:</p><ul><li>Download the current <em>installation_settings</em> using the <em>opsmgr</em> gem.</li><li>Manipulate the YAML to apply the configuration for the ERT tile</li><li>Re-upload the <em>installation_settings</em> file using the <em>opsmgr</em> gem.</li></ul><p><em>installation_settings</em> is completely undocumented, so we had to use trial and error to work out which fields in <em>installation_settings</em> corresponded to which fields in the Ops Manager GUI that we wanted to modify. One thing that helped us was <a href=http://www.colordiff.org/>colordiff</a> to easily visualise changes to the file. Another was to code as defensively as possible during the YAML-manipulation phase — if the file did not look exactly how we expected it to look, exit with a failure (otherwise known as &ldquo;use <a href=https://ruby-doc.org/core-2.2.0/Hash.html#method-i-fetch>fetch</a> everywhere&rdquo;)</p><p>Since <em>installation_settings</em> is the configuration for <em>all</em> products that Ops Manager is deploying, we also had to make use of Concourse <a href=https://concourse.ci/configuring-jobs.html#serial_groups>serial groups</a> later on when we were deploying multiple tiles, to ensure that we weren&rsquo;t overwriting the global configuration in two separate CI jobs.</p><h2 id=results>Results</h2><p>Our code is not pretty. We&rsquo;ve used some hacky methods to glue together tools that weren&rsquo;t really designed to work together. However what we do have is a pipeline that continuously deploys Cloud Foundry to multiple foundations on multiple IaaSs. Something that would take days manually following a run-book, now <strong>happens overnight while the team is sleeping</strong>. CVE exposure time can be measured in hours not weeks. And the ugly code we do have are small scripts that can be taken out back individually and euthanised as and when better methods become available (like when we upgrade to 1.8).</p><h3 id=testing>Testing</h3><p>Since we&rsquo;re now continuously upgrading Cloud Foundry, when we add features likes related to security or availability, it&rsquo;s not enough to accept those features on the current version. We need to write tests to assert the functionality so we can catch regressions. One of our requirements is that we can withstand loss of an availability zone (AZ). So after each deployment we run a test that:</p><ol><li>Destroys all VMs in an AZ</li><li>Checks the <a href=https://github.com/cloudfoundry/cf-smoke-tests>smoke tests</a> still pass</li><li>Re-creates the VMs</li></ol><p>Replacing manual tests with automated tests does take a while (especially for infrastructure), but you quickly build up the tooling to make each subsequent test easier to implement.</p><h3 id=small-cost-of-change>Small cost of change</h3><p>Our Cloud Foundry instances are now very much <a href=http://www.theregister.co.uk/2013/03/18/servers_pets_or_cattle_cern/>cattle</a>, not the pets they once were. This means we can easily destroy and replicate them — we can spin up new instances to spike potential features, and we can destroy dev environments at the end of the day to reduce costs. And when upgrades fail, it&rsquo;s much easier to diagnose and fix, because we&rsquo;re not paranoid about breaking things (they can always be reproduced).</p></div><div class="blog-page_banner clearfix"><div class=blog_banner-text><h2>Get in touch</h2><p>See how much we can help you.<br>Call <span>+44 (0) 20 7846 0140</span> or</br></p><a href=mailto:contact@engineerbetter.com class=cloud-btn2><p>Contact us <span>&#xe900;</span></p></a></div></div></section><footer><div class=footer-background></div><div class="footer_wrap clearfix"><div class=footer_column-list-desktop><ul class=list><li><a href=/how-we-work/><span>&mdash;</span> How we work</a></li><li><a href=/our-services/><span>&mdash;</span> Our services</a></li><li><a href=/success-stories/><span>&mdash;</span> Success stories</a></li><li><a href=/why-cloud-native/><span>&mdash;</span> Why Cloud-Native?</a></li><li><a href=/about-us/><span>&mdash;</span> About us</a></li></ul></div><div class=footer_column-list><ul class=list><li><a href=mailto:contact@engineerbetter.com><span>&mdash;</span> Contact us</a></li><li><a href=/blog/><span>&mdash;</span> Blog</a></li><li><a href=/join-our-team/><span>&mdash;</span> Join our team</a></li><li><a href=//www.iubenda.com/privacy-policy/8251825 class="iubenda-nostyle no-brand iubenda-embed" title="Privacy Policy"><span>&mdash;</span> Privacy Policy</a><script type=text/javascript>(function(e,t){var n=function(){var e=t.createElement("script"),n=t.getElementsByTagName("script")[0];e.src="//cdn.iubenda.com/iubenda.js",n.parentNode.insertBefore(e,n)};e.addEventListener?e.addEventListener("load",n,!1):e.attachEvent?e.attachEvent("onload",n):e.onload=n})(window,document)</script></li></ul></div><div class=footer_column-icon-wrap><a href=https://twitter.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-twitter.png></a>
<a href=https://github.com/EngineerBetter class=footer_column-icon><img class=footer_column-icon-img alt=Brand src=/img/icon-git-hub.png></a></div><div class=footer_column-text><p>&copy; Copyright EngineerBetter Ltd</p><p>Registered England & Wales 10141478</p></div></div></footer><script src="/js/jquery-1.11.3.min.js?v=4"></script>
<script src=/js/site.js></script></body></html>